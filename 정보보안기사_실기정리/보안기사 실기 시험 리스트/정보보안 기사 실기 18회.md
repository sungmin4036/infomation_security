#### ㅁ 정보보안기사 18회

[단답형]

1. EAP를 통해 인증을 수행하고 AES-CCMP 기반 암호화를 지원하는 무선랜 보안 표준은?

(답) WPA2 

* 최근 기출문제에서도 지속적으로 출제된 문제입니다. 점수를 주기 위한 문제이므로 반드시 맞춰야 합니다.

​

2. 바이러스 토탈(Virustotal)에서 제작하였고, 악성코드의 특성과 행위에 포함된 패턴을 이용하여 악성코드를 분류하는 툴의 이름은?

(답) YARA

* 보안관제 실무를 수행하는 분들에게는 익숙한 용어이겠으나, 그렇지 않은 대다수 분들은 맞추기 어려운 문제였습니다.

​

3.  SW 개발 보안과 관련하여 ( )에 들어갈 취약점명(공격기법)을 기술하시오. 

( A ) : DB와 연결되어 있는 애플리케이션의 입력값을 조작하여 의도하지 않은 결과를 반환하도록 하는 공격 기법

( B ) : 게시판, 웹, 메일 등에 삽입된 악의적인 스크립트에 의해 쿠키 및 기타 개인정보를 특정 사이트로 전송시키는 공격 기법

( C ) : 적절한 검증 절차를 수행하지 않은 사용자 입력값이 운영체제 명령어의 일부로 전달되어 의도하지 않은 시스템 명령어가 실행되도록 하는 공격 기법

(답) SQL Injection, XSS, 운영체제 명령어 삽입

​* 기출문제와 교재에 다수 등장했던 공격 기법입니다. 점수를 주기 위한 문제이므로 반드시 맞춰야 합니다.

​

4. 마이크로소프트 오피스와 애플리케이션 사이 데이터를 전달하는 프로토콜로 엑셀에서 이 기능이 활성화될 시 악용될 수 있다. 해당 프로토콜의 이름을 기술하시오.

(답) DDE(Dynamic Data Exchange)

* 기출문제와 동일하게 출제되었습니다. 점수를 주기 위한 문제이므로 반드시 맞춰야 합니다.

​

5. 위험관리와 관련하여 ( )에 들어갈 용어를 기술하시오. 

( A ) : ( B )로 부터 보호해야 할 대상

( B ) : ( A ) 에 손실을 발생시키는 원인이나 행위

( C ) : ( B ) 에 의하여 손실이 발생하게 되는 ( A )에 내재된 약점

(답) 자산, 위협, 취약점

* 위험 관리의 3요소는 기출문제와 교재에서 많이 다루어진 내용입니다. 반드시 맞춰야 하는 문제입니다.

​

​6. 정보의 무결성, 서비스의 연속성, 정보자산의 보호를 위한 것으로 기업 거버넌스의 부분집합으로서 전략적 방향을 제시하며 목적 달성, 적절한 위험관리, 조직 자산의 책임 있는 사용, 기업 보안 프로그램의 성공과 실패가 모니터링됨을 보장하는 것을 무엇이라고 하나?

(답) 정보보안 거버넌스

* 문제가 명확하지 않아 정보보안 거버넌스를 답으로 가정하고 문제를 복원했습니다. 정보보호관리체계는 정보자산의 무결성, 기밀성, 가용성을 보장하기 위한 절차와 과정을 체계적으로 수립, 문서화하고 지속적으로 관리 운영하는 체계입니다. 정보보안거버넌스는 정보보호관리체계 활동의 효과성을 보장하기 위하여 평가, 지시, 모니터링하는 상위 레벨에서의 프로세스 및 실행 체계입니다.

<br>

7. DDoS, APT 등 공격 수행 시 C&C 서버와 접속하기 위한 도메인명을 지속적으로 변경하여 보안장비의 탐지를 우회하기 위한 기법을 무엇이라고 하는가? ​

(답) DGA(Domain Generation Algorithm)

* 정답을 맞힌 분이 거의 없을 것으로 보이는 생소한 문제입니다. 

- [DGA](https://p3ngdump.tistory.com/77)는 공격 대상 시스템에 설치된 악성코드가 C&C와 통신하는 과정에서 특정한 규칙에 따라 도메인명을 임의로 생성하는 알고리즘입니다. C&C 서버로 접속하는 도메인명을 지속적으로 변경하기 때문에 보안장비의 Domain Reputation 기반 탐지 및 차단을 우회할 수 있습니다. 

- [Domain Shadowing](https://hakawati.co.kr/340)의 경우 적법한 절차로 도메인을 소유하고 있는 도메인 관리자의 개인 정보를 탈취하여, 도메인 소유자 몰래, 많은 서브도메인을 등록시켜 놓고 사용하는 기법입니다. 문제에서 도메인명을 임시로 부여한다고 했다면 Domain Shadowing이 아닌 DGA가 정답에 가까운 것으로 판단됩니다.


<br>


8. 위험분석절차 중 다음 ( )안에 들어갈 절차명을 기술하시오.

1) (  A  )

2) (  B  )

3) 기존 보안대책 평가

4) 취약성 평가

5) 위험평가

(답) 

( A ) : 자산식별

( B ) : 자산 가치 및 의존도 평가

* 교재에 있는 내용이나, 정확하게 절차명을 기술하기는 어려웠으리라 판단됩니다. 최소한 부분점수 1점(자산식별) 획득이 필요합니다. 

​

9. HTTP 관련 공격 중 헤더의 CRLF(개행문자) 필드 부분을 조작함으로써 웹서버로 조작된 HTTP 헤더를 지속적으로 보내 서비스의 가용성을 떨어뜨리는 공격은?

(답) Slow HTTP Header DoS 공격(Slowloris)

* 교재와 기출문제로 많이 다루어진 문제로 반드시 맞춰야 합니다.

​

10.  모바일 앱의 특정화면으로 바로 이동할 수 있도록 지원하는 기능으로 공격자에 의하여 악용되는 경우 앱내 민감한 개인정보(카드정보, 주소 등)가 노출될 수 있는 취약점이 있다. 이 기능의 이름은 무엇인가?

(답) 모바일 딥링크

* 정답을 맞춘 분이 거의 없을 것으로 보이는 생소한 문제입니다.

​

[서술형]

11. SQL Injection을 예방하기 위한 prepared statement 에 대하여 다음 물음에 답하시오.

(1) prepared statement 의 개념

(2) prepared statement가 SQL injection 공격을 막을 수 있는 이유

(답) 


```
* PreparedStatement 와 Statement의 가장 큰 차이점은 캐시(cache) 사용여부이다.

1) 쿼리 문장 분석
2) 컴파일
3) 실행
```

(1) 최초에 한번 쿼리를 분석해 최적화 수행 후 메모리에 저장해 두고, 다음 요청 부터는 저장된 결과를 재사용하여 쿼리를 수행하는 방식이다. 성능 측면의 효율이 높고, SQL 인젝션 방지가 가능하다. 참고로 일반 statement 방식은 실행시마다 쿼리를 분석해 최적화 수행후 실행하는 방식이라 효율이 낮고 SQL Injection 공격에 취약함.

(2) 사용자가 입력한 값이 SQL 명령의 일부가 아닌 매개 변수로 처리되기 때문에 SQL 인젝션 공격을 막을 수 있음.

예) statement 방식

```
String query = "INSERT into student VALUES('" + user + "')";
Statement stmt = conn.createStatement();
stmt.executeQuery(query);
```

user에 Robert');DROP table students;-- 값을 입력면 다음과 같이 SQL명령문의 일부로 처리되어 students 테이블이 drop되게 됨.

```
INSERT into student VALUES('Robert');DROP table students;--')
```
​

예) preparedstatement 방식

```
PreparedStatement stmt = conn.prepareStatement("INSERT into student VALUES(?)");
stmt.setString(1,user);
stmt.execute();
```
​
user에 Robert');DROP table students;-- 값을 입력하더라도 해당 값이 그대로 매개변수로 user 컬럼에 입력이 됨. 

​* Prepared Statement 문에 대한 이해가 없으면, 답변하기 까다로운 문제 입니다. 교재에 있는 예문을 최대한 끄집어 내어, statement 방식과 비교를 통해 설명을 한다면 좀 더 효과적인 답변이 될 수 있습니다. 부분점수 7점 이상 획득이 필요합니다.

​

12. DRDoS에 대하여 다음을 설명하시오. 

1) DRDoS의 공격 원리

2) 기존 DoS와의 차이점

3) Unicast RPF 

(답) 

1. 공격자는 소스 IP를 공격대상의 IP로 위조하여 다수의 반사서버로 요청을 보내고, 공격대상 서버는 반사서버로 부터 다수의 응답을 받아 서비스 거부 상태에 빠짐

2.   
   
a) 출발지 IP가 위조되고, 반사서버를 통해 공격이 수행되므로 공격의 출처를 파악하기 어려움.

b) 다수의 좀비 PC를 동원하지 않더라도 대량의 공격 패킷을 만들어 낼수 있어 효율이 높음 

3. ​인터페이스를 통해 들어오는 패킷의 ip에 대하여 라우팅 테이블을 확인하여 들어온 인터페이스로 나갈 수 있는 Reverse path가 존재하면 통과시키고, 존재하지 않으면 IP가 위조된 것으로 판단하고 차단 시킴

* DRDoS, Unicast RPF는 교재에 있는 토픽이므로 10점 이상 획득이 필요 합니다. 

​
```
라우팅 테이블(영어: routing table)은 컴퓨터 네트워크에서 목적지 주소를 목적지에 도달하기 위한 네트워크 노선으로 변환시키는 목적으로 사용된다.
각 라우터의 라우팅 테이블은 모든 목적지 정보에 대해 해당 목적지에 도달하기 위해서 거쳐야 할 다음 라우터의 정보를 가지고 있다.
```




13. 패킷 필터링 방화벽과 관련하여 다음 물음에 답하시오.

1) 존재하지 않는 외부 IP를 이용한 Spoofing 공격에 대응하기 위한 패킷필터링 방화벽 기술의 이름과 원리

2) 공격자가 패킷을 소형 단편화하여 tiny fragment 공격을 수행하는 이유

3) Tiny fragment 공격 대응 방법

4) stateful 패킷필터링과 일반 패킷 필터링 방화벽의 차이점

(답) 

1) Ingress 필터링 : 인터넷 상에서 사용되지 않는 IP 대역은 들어오지 못하게 차단함. 

2) 쪼개진 패킷을 재조합하는 기능을 제공하지 않는 방화벽의 경우 이렇게 다수로 쪼개진 패킷을 탐지하거나 차단할 수 없는 약점이 있기 때문임.

3-1) 단편화된 패킷을 재조합하는 기능이 있는 방화벽을 사용

3-2) Port 번호가 포함되어 있지 않을 정도로 분할된 패킷은 필터링 장비(IDS, IPS)에서 탐지 or 차단.

4-1) 일반 패킷 필터링 방화벽은 지나가는 패킷 헤더안의 IP주소와 Port 주소만을 단순검색하여 통제함. Tiny fragment 와 같은 공격에 취약하나 처리 속도는 빠름.

4-2) Stateful 패킷 필터링 방화벽은 동일한 출발지 IP주소, 출발지 포트 번호, 목적지 IP주소, 목적지 포트 번호 상태 등을 갖는 패킷들의 상태를 저장하고 그룹으로 필터링 함으로써 일반 패킷 필터링 방식보다 신뢰성 높고 정교하게 공격을 막을 수 있음. 예를 들어 SYN 요청을 통해 Establish가 되지 않은 상태에서 Establish된 것처럼 조작된 패킷은 차단 가능함.

* Stateful Inspection 기반 방화벽은 교재에 포함된 토픽 입니다. 물어본 4개의 문항을 정확히 맞추기는 어렵겠으나, stateful에 대하여 이해하고 있는 내용을 기반으로 최대한 성의있고 치열하게 답안을 작성하는 것이 중요합니다. 부분 점수 3~5점 획득이 필요합니다.

​

[실무형]

14. 다음은 email 관련 로그이다. 이에 대하여 다음 물음에 답하시오.

[Email로그]

```
1 Delivered-To: hbiden@rosemontseneca.com
2 Received: by 10.36.47.149 with SMTP id j143csp13601itj;
3 Fri, 17 Apr 2015 06:00:53 -0700 (PDT)
4 X-Received: by 10.55.27.42 with SMTP id b42mr5166039qkb.53.1429275653296;
5 Fri, 17 Apr 2015 06:00:53 -0700 (PDT)
6 Return-Path: <v.pozharskyi.ukraine@gmail.com>
7 Received: from mail-qc0-x232.google.com (mail-qc0-x232.google.com. [2607:f8b0:400d:c01::232])
8 by mx.google.com with ESMTPS id u123si11512941qhd.83.2015.04.17.06.00.52
9 for <hbiden@rosemontseneca.com>
10 (version=TLSv1.2 cipher=ECDHE-RSA-AES128-GCM-SHA256 bits=128/128);
11 Fri, 17 Apr 2015 06:00:53 -0700 (PDT)
12 Received-SPF: pass (google.com: domain of v.pozharskyi.ukraine@gmail.com designates 2607:f8b0:400d:c01::232 as permitted sender) client-ip=2607:f8b0:400d:c01::232;
13 Authentication-Results: mx.google.com;
14 spf=pass (google.com: domain of v.pozharskyi.ukraine@gmail.com designates 2607:f8b0:400d:c01::232 as permitted sender) smtp.mail=v.pozharskyi.ukraine@gmail.com;
15 dkim=pass header.i=@gmail.com;
```


1) 10번째 줄에서 RSA의 용도는?

2) 이메일 로그에서 확인할 수 있는 스팸메일 대응 기법명과 동작원리를 설명하시오. 

(답) 

1) 인증서(서버 공개키) 검증을 위하여 사용됨. 즉, TLS 로 암호화통신을 하기 위하여 ECDHE로 키교환을 하는 과정에서 생성되는 변수를 송신자의 개인키로 서명하고 공개키로 검증하도록 함으로서 송신자의 정당성을 인증하기 위함. 이를 통하여 키교환 과정에서의 중간자 공격을 막을 수 있음. 

*참고로 cipher에서 ECDHE는 키교환, RSA는 인증, AES128로 암호화, GCM(Galois/Counter Mode)으로 블록암호화 운용방식 선택, SHA256으로 메시지 인증(무결성 검증)을 의미함.

​

2-1) SPF : 이메일 발송도메인의 DNS에 txt레코드로 등록된 IP주소와 실제 메일의 송신 IP를 비교하여 메일 도메인의 정당성을 검증

2-2) DKIM : 이메일 서버의 개인키로 이메일 헤더를 전자서명하고, 메일 도메인서버의 txt레코드로 등록된 공개키로 검증하도록 함으로써, 메일 헤더가 변조되지 않았고 실제 해당 도메인에서 발송된 것을 확인 가능

​

* 실제 문제에서 제시된 로그에서 spf, dkim이 모두 나왔다고 가정하고 답안을 작성했습니다. SPF, DKIM은 기출문제이기 때문에 정확하게 이해하고 있어야 합니다. 그리고, RSA를 많은 분들이 암호화라고 하신 것 같은데, 인증이 맞습니다. 부분점수 7점 이상 획득이 필요한 문제입니다.

​

15. 리눅스의 보안 설정과 관련하여 다음 물음에 답하시오.

1) 계정임계값을 설정하는 파일명( A )과 ( B ) 에 들어갈 설정값을 기술하시오.

auth required /lib/security/pam_tally.so ( B ) =5 unlock_time=120 no_magic root reset

2) IPTable에 신규 정책을 등록하려고 한다. 패킷을 차단하기 위해 ( C )에 들어갈 옵션은 무엇인가? 

#iptables -A INPUT -p tcp -s 172.30.1.55 --dport 21 -j ( C )

3) /etc/shadow 파일의 소유자를 root로 변경하고(D), 소유자에게만 읽기 권한을 부여(E)하기 위한 명령어를 기술하시오.

4) 다음 아파치 설정에서 Limitrequestbody 5000000 의 의미(F)를 설명하시오.

```
<Directory "var/www/html/uploads">
Limitrequestbody 5000000
</Directory>
```


​(답) 

(1-A) /etc/pam.d/system-auth or /etc/pam.d/common-auth

(1-B) deny

(2-C) DROP

(3-D) chown root /etc/shadow

(3-E) chmod 400 /etc/shadow

(4-F) 아파치 웹서버에 업로드 가능한 파일의 크기를 5,000,000 바이트(약 5M바이트)로 제한함으로써 악의적인 웹 쉘 업로드를 방지하기 위한 설정임.

​* 리눅스 OS 보안과 관련하여 기출문제로 자주 출제되었던 항목이 통합되어 출제 되었습니다. 10점 이상 획득이 필요합니다. 

​

16. 특정 공격과 관련된 로그를 보고 다음 물음에 답하시오.

[로그]

```
DNS standard query 0x2872 ANY cpsc.gov United states Korea, Republic of
DNS standard query 0x2872 ANY cpsc.gov United states Korea, Republic of
DNS standard query 0x2872 ANY cpsc.gov United states Korea, Republic of
DNS standard query 0x2872 ANY cpsc.gov United states Korea, Republic of
```
​

1) 어떤 공격이 수행된 것인가? 

2) 해당 공격이 수행된 것으로 판단한 이유는?

3) 해당 공격의 원리는?

4) 공격자들이 이 기법을 사용하는 이유 두 가지는?

​

(답) 

1) DNS 증폭 DoS 공격(DNS amplifcation DoS attack)

2) DNS query 수행시 ANY 타입으로 질의를 다수 수행하였음. 

3) 출발지 IP를 공격 대상 서버의 IP로 위조 후 DNS 쿼리 타입을 ANY로 지정하여 request를 대량으로 수행하면, 다양한 TYPE의 레코드들이 모두 Response 되므로 응답이 증폭되어 공격 대상 서버에 부하를 주게됨

4-1) 출발지 IP가 위조되고, 반사 서버를 통해 공격이 수행되므로 공격의 출처를 파악하기 어려움. 특히 UDP는 별도의 인증 절차가 없으므로 공격 수행이 용이함

4-2) 다수의 좀비 PC를 동원하지 않더라도 대량의 공격 패킷을 만들어 낼 수 있어 효율이 높음.

특히 쿼리 타입을 any나 txt로 하면 reponse 사이즈가 증폭되어 작은 사이즈의 DNS 질의에 대해 큰 사이즈의 DNS 응답 메시지 발생되어 증폭 효과가 큼. 90바이트 질의, 3370바이트 응답(37.4배 증폭 효과)

​
<br>
<br>
<br>

---


###  ㅁ 방화벽

ㅁ 구현 방식에 따른 유형

- 패킷 필터링(Packet Filtering)
  
: 패킷 필터링은 OSI7 계층에서 네트워크 계층과 전송 계층에서 동작한다. 

해당 계층의 데이터를 가지고 인바운드와 아웃바운드 서비스를 제공하는 것으로 네트워크 계층에서는 IP 주소, 전송 계층에서는 Port주소와 TCP, UDP 의 프로토콜 종류에 대한 데이터를 얻을 수 있다.

해당 데이터들을 바탕으로 방화벽 정책을 세워 패킷을 필터링 한다.

장점으로는 다른 방화벽에 비해 속도가 빠르다. 확인하는 데이터가 다른 방화벽에 비해 적기 떄문이다. 또한 사용자에게 투명성을 제공하며, 새로운 서비스에 대해 비교적 쉽게 연동이 가능하다.

단점은 TCP/IP의 구조적 문제로 인해 네트워크 계층과 전송 계층의 패킷 헤더를 쉽게 조작할 수 있다는 점으로 필터링을 비교적 쉽게 우회할 수 있다. 

또한 네트워크와 전송 계층만을 다루기 때문에 수집되는 정보가 한정적이고 해당 정보에 대한 로그만으로는 사용자가 어떤 행위를 했는지 등을 유추하기 힘들다.

<br>
<br>

- 애플리케이션 게이트웨이(Application Gateway)

: 애플리케이션 게이트웨이는 이름에서도 알 수 있듯이 애플리케이션 계층에서 동작하는 방화벽이다. 

애플리케이션 계층에서 동작하는 만큼 로그에서 다양한 정보를 얻을 수 있으며 여러 유용한 기능들을 추가할 수 있다. 

애플리케이션 게이트웨이는 Proxy Daemon을 이용하여 각 프로토콜을 개별적으로 관리할 수 있는데 그래서 Proxy Gateway라고도 한다. 

여기서 프록시(Proxy)는 특정 작업을 수행하기 위해 가상의 객체를 만들어서 부가적인 작업을 수행할 수 있게 해주는 것이다. 그리고 Daemon은 프로세스를 관리하는 프로세스라고 생각하면 된다.

프록시 하면 프록시 서버도 생각날 수 있다. 간단히 프록시 서버를 설명해본다. 

프록시 서버는 여러 목적으로 사용될 수 있는데 원래 목적은 좀 더 빠르게 웹을 이용하기 위해 사용되었다. 

최근에는 IP 우회 등을 통해 특정 국가 IP로 접근할 수 없는 사이트를 접근하는 형태로도 사용된다. 

프록시의 작동원리는 프록시 서버가 있고, 해당 프록시 서버를 통해 웹을 사용하려는 사용자가 있다.  

사용자는 프록시 서버에게 원하는 웹사이트를 요청한다. 

그러면 프록시 서버는 자신의 서버에 해당 사이트가 있는지 확인하고 있다면 해당 사이트를 사용자에게 바로 제공한다. 

또는 사이트가 없다면 요청한 사이트에 접근하고 페이지에 대한 정보를 서버에 저장하여 사용자에게 제공한다. 

이렇게 되면 해당 프록시 서버를 사용하는 사용자는 프록시 서버에 저장된 사이트의 경우 비교적 빠르게 접근할 수 있게 된다. 

이 과정을 보면 IP 우회가 왜 되는지도 알 수 있다. 사용자는 프록시 서버에게 페이지를 요청하고 실질적으로 페이지를 요청하는 서버는 프록시 서버이기 때문에 응답하는 웹 페이지는 프록시 서버의 IP로 응답하게 된다. 

떄문에 다른 IP로 우회하여 접근하는 느낌으로 사용할 수 있는 것이다.

이어서 애플리케이션 게이트웨이에 대한 설명이다. 애플리케이션 계층에서 동작하기 떄문에 많은 정보를 얻을 수 있다. 

해당 정보를 바탕으로 사용자가 어떤 IP, Port로 접근했는지 접근해서 뭘 했는지 등을 알 수 있으며 해당 정보들을 통하여 악의적인 사용자에 대한 행동을 분석하고 어떤 피해를 당했는지 등 사고 분석을 할 수 있다.

장점으로는 Proxy를 통해서 연결이 허용되므로 내부 IP 주소를 숨길 수 있다. 

즉, 이전에 설명한 프록시 서버와 같은 원리로 중간에 프록시 서버를 거쳐서 내부로 접근하기 때문에 외부에 노출되는 IP는 프록시 서버의 IP가 노출된다. 

또한, 얻을 수 있는 정보가 많기 때문에 해당 정보들을 바탕으로 구체적인 정책을 세울 수 있어서 패킷 필터링에 비해 보안성이 우수하다.

단점으로는 새로운 서비스에 대한 유연성이 떨어지고 프록시를 한 번 거쳐서 오면서 여러 작업이 실행되어 성능이 떨어질 수 있다.

<br> 
<br>

- 회선 게이트웨이(Circuit Gateway)

: 회선 게이트웨이는 애플리케이션 계층과 세션 계층사이에서 동작한다. 

앞의 애플리케이션 게이트웨이에서 좀 더 수월한 관리를 위해 사용되며 똑같이 프록시를 이용한 필터링을 진행한다. 

단, 회선 게이트웨이에서는 클라이언트 측에서 프록시를 인식할 수 있는 수정된 클라이언트 프로그램이 필요로하며 해당 프로그램이 설치된 클라이언트에서만 회선이 형성되어 통신이 가능하도록 한다. 

프록시와 클라이언트를 연결해주는 프로그램으로는 SOCKS가 있다.

장점은 내부의 IP 주소를 숨길 수 있으며 투명한 서비스를 제공한다. 또한, 애플리케이션 게이트웨이에 비해서 관리가 수월하다.

단점은 SOCKS와 같은 프로그램이 필요하다는 것과 비표준 포트로 우회 접근 시 방어가 불가능하다는 점이있다.

<br>
<br>

- 상태 기반 패킷 검사(Stateful Packet Inspection)

: 상태 기반 패킷 검사는 방화벽 중 가장 강력한 것으로 OSI의 모든 계층에서 패킷을 분석하여 차단하는 기능을 한다. 

패킷 필터링 방식에서 세션 추적 기능이 추가되었으며 패킷의 헤더 내용을 해석하여 정책에 위배되는 패킷은 차단해버린다. 

패킷 필터링의 기술을 사용하여 클라이언트/서버 모델을 유지하면서 모든 계층의 전후 상황에 대한 문맥 데이터를 제공하여 기존 방화벽의 한계를 극복했다. 

이러한 상태 기반 패킷 검사에서 한 단계 더 발전한 형태가 심층 패킷분석(Deep Packet Inspection)이다. 

심층 패킷 분석은 패킷이 가지고 있는 콘텐츠까지 모두 검사하여 다양한 콘텐츠를 식별하고 분석할 수 있는 강력한 침입 차단 시스템이다. 

OSI 전 계층에 대해서 접근 통제도 할 수 있다.

장점으로는 서비스마다 특성, 통신 상태를 관리할 수 있기 때문에 동적으로 접근 규칙을 생성할 수 있다.

단점으로는 데이터 내부에 악의적인 정보를 포함할 수 있는 프로토콜에 대한 대응이 어렵다. 즉, 원래 의도한 방향과 다르게 악의적으로 사용될 수 있는 프로토콜에 대해 대응이 어려울 수 있다.

<br>
<br> 

- 혼합형 타입(Hybrid type)

: 서비스 종류에 따라 복합적으로 구성하는 것이다.

장점은 서비스의 종류에 따라 사용자의 편의성, 보안성 등을 고려하여 방화벽 기능을 선택적으로 부여할 수 있다.

단점은 구축 및 관리가 어렵다.



<br>
<br>
<br>

ㅁ 방화벽 시스템 구축 유형

![image](https://user-images.githubusercontent.com/62640332/162990275-344796a6-99bc-4a7e-b316-ca0d08acbf04.png)




1. 스크리닝 라우터(Screening Router)     
: IP, TCP, UDP 헤더 부문에 포함된 내용만 분석하여 동작 내부 네트워크와 외부 네트워크 사이의 패킷 트래픽을 허락 및 거절 하는 라우터

![image](https://user-images.githubusercontent.com/62640332/162990298-9a5aa303-de60-4f49-97f6-b40a4231318e.png)


<br>

2. 베스천 호스트(Bastion Host)    
: 내부 네트워크 전면에서 내부 네트워크 전체를 보호하며 외부 인터넷과 내부 네트워크를 연결하는 라우터 뒤에 위치한다. Lock down 된 상태에 있으며 인터넷 접근이 가능한 서버

![image](https://user-images.githubusercontent.com/62640332/162991583-841213e4-c2f6-48f6-a03b-92840374cc13.png)


<br>

3. 듀얼 홈드 호스트(Dual-Homed Host)     
: 2개의 네트워크 인터페이스를 가진 배스천호스트로서 하나의 NIC는 내부 네트워크와 연결하고 다른 NIC는 외부네트워크와 연결한다.   
방화벽은 하나의 네트워크에서 다른 네트워크로 IP 패킷을 라우팅하지 않기 떄문에 프록시 기능을 부여한다.

![image](https://user-images.githubusercontent.com/62640332/162991622-d80923b9-d0ed-4981-9941-3fe456b22ef8.png)


<br>

4. 스크린드 호스트(Screend Host)    
: 패킷 필터링 라우터와 베스천 호스트로 구성    
패킷 필터링 라우터는 외부 및 내부 네트워크에서 발생하는 패킷을 통과시킬 것인지 검사하고 외부에서 내부로 유입되는 패킷에 대해서는 배스천호스트로 검사된 패킷을 전달한다.    
패스천호스트는 내부 및 외부 네트워크 시스템에 대한 인증을 담당한다.

![image](https://user-images.githubusercontent.com/62640332/162990424-5e339c45-2af3-49f6-a8bf-5ba6454f831e.png)


<br>

5. 스크린드 서브넷(Screend Subnet)    
: 스크린드 호스트와 보안상 문제점을 보완한 모델입니다.    
외부 네트워크와 내부 네트워크 사이에 하나 이상의 경계 네트워크를 두어 내부 네트워크를 외부 네트워크로부터 분리 하기 위한 구조

![image](https://user-images.githubusercontent.com/62640332/162991779-2e994d40-ffc1-4dbe-9339-e256324992f0.png)



<br>
<br>
<br>


- Ingress 필터링

: 라우터 외부에서 라우터 내부로 유입되는 패킷을 필터링하는 것이다.

패킷의 소스 IP 나 목적지 포트 등을 체크하여 허용하거나 거부하도록 필터링 하는 것을 뜻한다. 

공통적으로 필터링 하여야할 소스 IP는 인터넷 상에서 사용되지 않는 IP 대역

(대부분의 공격이 실제 존재하지 않는 위조된 IP 주소를 소스로 함)

<br>

- Egress filtering 

: 라우터 내부에서 라우터 외부로 나가는 패킷의 소스ip를 체크하여 필터링

라우터를 통과하여 나가는 패킷의 소스 IP는 반드시 라우터와 같은 대역이여야 한다.

(라우터를 통해 나가는 패킷의 소스 ip 중 사용중인 ip 대역을 소스로 한 패킷은 허용하고 나머지는 거부 하도록 설정)

<br>

- Blackhole filtering(Null routing 을 활용한 필터링)

: 특정한 ip 대역에 대해서 Null 이라는 가상의 쓰레기 인터페이스로 보내도록 함으로써 패킷의 통신이 되지 않도록 함

<br>

- Unicast RPF

: 인터페이스를 통해 들어오는 패킷의 소스 ip 에 대해 라우팅 테이블을 확인하여 들어온 인터페이스로 다시 나가는지 확인


---


### ㅁ Fragment의 취약점을 이용한 공격기술

: fragment를 조작함으로써 패킷 필터링 장비나 침입차단시스템을 우회 또는 서비스거부공격을 유발 시킬 수 있다.

모든 인터넷 모듈은 IP 헤더를 제외한 8바이트의 데이터(Payload)를 최소 Fragment 크기를 갖도록 RC 791에서 명시하고 있다. 

그러나 TCP 와 같은 프로토콜은 포트 번호와 같은 중요 헤더 정보가 8바이트의 Fragment 패킷 내에 포함된다는 것을 보장하지 못하기 때문에 보안상 허점으로 이용될수 있다.

TinyFragment 공격은 이 허점을 이용하여 필터링 규칙 내에 TCP Flag 정보를 이용하여 검사하는 패킷 필터를 빠져나가,

TCP Falg 정보를 두번째 Fragment 패킷에 의도적으로 포함시켜서 보낸다.

패킷 필터에서는 Fragment된 두번쨰 이후의 모든 IP 패킷에 대해서는 검사하지 않고 그대로 통과시키기 떄문에 최종 목적지에 도착하게 되고

완전한 하나의 패킷으로 재결합된다.


<br><br>

ㅁ Tiny fragment 공격
 
- 최초의 fragment를 아주 작게 만들어서 네트워크 침입탐지시스템이나 패킷 필터링 장비를 우회하는 공격

TCP 헤더(일반적으로 20바이트)가 2개의 fragment에 나뉘어질 정도로 작게 쪼개서 목적지 TCP 포트번호가 첫 번째 fragment에 위치하지 않고 두 번째 fragment에 위치하도록 한다. 
 
패킷필터링 장비나 침입탐지시스템은 필터링을 결정하기 위해 포트번호를 확인하는데 포트번호가 포함되지 않을 정도로 아주 작게 fragment된 첫 번째 fragment를 통과시킨다.

다음으로 들어오는 fragment의 경우 포트번호가 포함되어 있지만 필터링을 거치지 않고 통과시킨다.

- 최근 필터링 장비에는 TCP 헤더의 포트번호가 포함되지 않을 정도로 작은 첫 번째 fragment는 drop시키기도 한다.

- 해당 공격 기법은 nmap을 통해서도 공격이 가능하다. (-f 옵션을 이용)

<br><br>

ㅁ Fragment Overlap 공격

- Tiny fragment 공격기법에 비해 좀 더 정교한 공격기법

공격자는 공격용 IP 패킷을 위해 두 개의 fragment를 생성한다. 첫 번째 fragment에서는 필킷 필터링 장비에서 허용하는 http(TCP 80) 포트와 같은 포트번호를 가진다. 

두 번째 fragment에서는 offset을 아주 작게 조작해서 fragment들이 재조합될 때 두 번째 fragment가 첫 번째 fragment의 일부분을 덮어쓰도록 한다. 

일반적으로 공격자들은 첫 번째 fragment의 포트번호가 있는 부분까지 덮어씌운다. 

IDS에서는 첫 번째 fragment는 허용된 포트번호이므로 통과시키고, 두 번째 fragment는 이전에 이미 허용된 fragment의 ID를 가진 fragment이므로 역시 통과시킨다. 

이 두 개의 fragment가 목적지 서버에 도달하여 재조합되면 첫 번째 fragment의 포트번호는 두 번째 fragment의 포트번호로 overwrite되고 TCP/IP 스택은 이 패킷을 필터링 되어야할 포트의 응용프로그램에 전달한다.

<br><br>

ㅁ IP Fragmentation을 이용한 서비스거부공격

- Ping of Death 혹은 Teardrop과 같은 것이 fragmentation을 이용한 서비스거부공격

- 해당 공격들은 이미 잘 알려져 있으며 많은 시스템에서 이미 패치가 완료되었음

- Ping of Death : 표준에 규정된 길이 이상으로 큰 IP 패킷을 전송함으로써 이 패킷을 수신받은 OS에서 이 비정상적인 패킷을 처리하지 못함으로써 서비스거부공격을 유발 (Jolt 이용)

- Teardrop : 두 번째 fragment의 offset을 조작하여 fragment들을 재조합하는 과정에서 버퍼를 넘쳐 겹쳐쓰게 한다. 

Teardrop 프로그램은 겹쳐쓰진 offset 필드를 가진 fragment를 만들어 목표 시스템에 보내며, fragment들을 재조합하는 목표 시스템을 정지시키거나 재부팅시킨다.(Bonk, New Teardrop 이용)

<br><br>

ㅁ 기타 사용 가능한 툴

- fragrouter : 한국인 해커 송덕준(Dug Song이란 닉네임으로 활동)이 만든 툴로 모든 패킷을 다양한 형태의 fragment로 쪼개어서 전송함으로써 공격사실을 숨길 수 있는 툴.


ㅁ 대응방법

: RFC 1858에서 제시한 기법은 Fragment된 첫 번쨰 IP 패킷의 데이터 크기를 보고 패킷의 폐기 유무를 판단하는 것이다.

TCP의 경우 패킷 필터링 검사의 대상이 되느 필드들의 TCP 헤더 부분의 20 바이트 범위 내에 있기 떄문에 TCP 데이터를 포함한 첫 번째 IP Fragment 패킷의 최소한 20바이트의 데이터를 갖고 있지 않다면 그 패킷은 폐기 시킨다.

이렇게 첫 번쨰 IP Fragment 패킷의 최종 목적지에 도달하지 못하면 나머지 IP Fragment 패킷이 최종 목적지에 도달하더라도 재결합 불가능하여 효과적으로 차단 가능.

<br><br>

- 호스트 에서의 IP Fragment 처리

: 최종 목적지 호스트에서는 분리된 IP 패킷을 원래 하난의 IP 패킷으로 재결합 시키기 위해서 도착하는 IP Fragment 패킷들을 버퍼에 저장한후 모든 IP Fragment 패킷이 도착하면 재결합을 한다.

이 떄 IP Fragment 패킷을 임시로 저장하는 버퍼는 제한된 크기의 메모리 이끼 때문에 많은 양의 IP Fragment 패킷이 도달하면 버퍼 순위를 유지하기 위한 메커니즘을 적용하여 계속해서 유입되는 IP Fragment 패킷을 받게된다.

리눅스에서는 이러한 IP fragment버퍼의 조절을 위해서 크게 두가지 메커니즘을 적용하고 있다.

<br>

1. IP fragment 패킷이 처음 도착하면 하나의 큐가 할당되고 모든 IP Fragment 패킷이 도착해서 재결합을 해얗나느 ㅅ한계 시간의 타이머가 설정된다.

만약 설정된 타이머가 종료된 후에도 모든 IP Fragment 패킷 도착 않으면 큐에 저장되어 있던 모든 IP Fragment 패킷과 큐에 사용된 메모리가 반환 된다.

현재 리눅스 기본값은 30초 이다. 또한 proc 파일시스템 형태인 ipfarg_time을 통해 기본 설정 값 변경 가능할수 있다.

이와 같은 Timeout 메커니즘에서 처음 IP Fragment 패킷이 도착하면 새로운 큐를 할당하고 타이머가 종료될떄 까지 큐는 메모리에 보존된다.

그러나 타이머가 종료되기 전에 많은 양의 새로운 IP Fragment 패킷이 수신되면 계속해서 큐가 할당되고 나중에는 큐로 할당된 메모리의 제한을 넘어서게 된다.

<br>

2. 리눅스에서는 이렇게 큐로 할당된 메모리 이상의 IP Fragment 패킷이 수신시 가장 오래된 큐부터 강제적으로 반환시키는 LRU 알고리즘 사용한다.

만약 IP Fragment 패킷을 저장하는데 사용된 메모리가 제한값 을 넘어가면 강제적으로 메모리를 반환시키기 위한 함수인 ip_evictor를 호출하게 된다.

리눅스 메모리 제한값은 기본값으로 256KB 이다.

위 방식대로 시간을 짧게 설정하여 어느정도 대응은 가능하지만, 짧은 시간에 대량으로 유입되는 IP Fragmnet 공격에 대해서는 번번한 ip_evictor 함수만이 실행되기 때문에 다른 패킷이 재결합 되는 과정 방해 불가능하여 효과적 대응 X

<br>

==> 동적 패킷필터링 기법

기존의 패킷필터링은 패킷 헤더에 기반한 정적인 규칙을 제공하면 경유되는 모든 패킷에 대해서 검사를하고 패킷의 통과 여부를 결정한다.

처음 IP Fragment 퍀시이 통과시 IP에 대한 목록을 필터링 규칙에 동적으로 추가하고 타이머 설정한다.

이후에 새로 추가된 규칙에 해당하는 IP Fragment 패킷이 통과하면 패킷은 그대로 통과되고, 지금까지 통과되는 트래픽 양을 계산하게 된다.

만약 타이머가 종료되기 전까지 이상 트래픽이 발견되지 않으면 해당 규칙은 자동으로 삭제된다.

그러나 추가된 규칙에 해당하는 IP Fragment 패킷의 트래픽이 기준치 이상으로 증가하면 해당 필터링 규칙은 해당 IP 주소로 패킷이 더이상 통과 못하도록 하는 차단 규칙으로 변경된다.
