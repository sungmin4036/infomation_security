[ㅁ 안랩, 클롭 랜섬웨어 분석](#ㅁ-안랩-클롭-랜섬웨어-분석)
[ㅁ 솔라윈즈 SUNBURST 보안 해킹(공급망 공격)](#ㅁ-솔라윈즈-sunburst-보안-해킹공급망-공격)
[ㅁ MS 익스체인지 서버 취약점을 악용한 분석 사례](#ㅁ-ms-익스체인지-서버-취약점을-악용한-분석-사례)
[ㅁ 속닉월의 이메일 보안 솔루션의 제로데이 취약점](#ㅁ-속닉월의-이메일-보안-솔루션의-제로데이-취약점)
[ㅁ 펄스시큐어 VPN에 대한 사이버 공격 활발](#ㅁ-펄스시큐어-vpn에-대한-사이버-공격-활발)
[ㅁ FireEye, DarkSide 연계 조직 활동 파악](#ㅁ-fireeye-darkside-연계-조직-활동-파악)
[ㅁ 원격접근 방법의 취약점](#ㅁ-원격접근-방법의-취약점)
[ㅁ 스마트폰 앱 취약점](#ㅁ-스마트폰-앱-취약점)
[ㅁ 랜섬웨어](#ㅁ-랜섬웨어)
[ㅁ 비트라커(BitLocker)](#ㅁ-비트라커bitlocker)
[ㅁ 아바돈(Avaddon) 랜섬웨어](#ㅁ-아바돈avaddon-랜섬웨어)
[ㅁ 다르마(Dharma) 랜섬웨어](#ㅁ-다르마dharma-랜섬웨어)
[ㅁ 오버플로우](#ㅁ-오버플로우)
[ㅁ 명령어 삽입(Command Injection)](#ㅁ-명령어-삽입command-injection)
[ㅁ 부적절한 권한 검증](#ㅁ-부적절한-권한-검증)
[ㅁ 서비스 내 오픈소스 파일 업로드 취약점](#ㅁ-서비스-내-오픈소스-파일-업로드-취약점)
[ㅁ IoT 오버플로우](#ㅁ-iot-오버플로우)

---

### ㅁ 안랩, 클롭 랜섬웨어 분석

안랩은 2019년 국내에서 클롭 랜섬웨어 의한 피해 크다고 보고

- 공격 방법

: 클롭 일당은 공격 대상을 명확히 하여 스피어피싱으로 공격ㅇ르 시작. 이메일 수신자를 지정하고, 본문애용은 공격 대상의 사용 언어에 맞게 공교하게 작성함

키보드 배열과 문자 셋을 확인하고 러시아와 러시아가 주도하는 독립국가연합(CIS)이면 클롭 랜섬웨어가 동작하지 않도록 하여,  비러시아계 국가만 공격하는 특징 가짐.

<br>

- 클롭 랜섬웨어의 공격 과정

: 준비 - 장악 - 실행의 1단계로 나눌수 있음

<br>
<br>
<br>

- 준비 : 최초 공격 대상에게 이메일로 악성문자 첨부파일을 전달해 원격제어 악성코드 설치
  - 이메일에 첨부된 악성 문서 파일(엑셀, 워드)을 사용자가 열람
  - 문서 파일에 삽입된 매크로를 통해 원격제어 악성코드의 다운로더 실행
  - 해당 시스템이 AD에 가입되어 운영되면 원격제어 악성코드 파일을 다운로드 후 실행(AD 환경을 노림)
  - 원격제어 악성코드 팡리을 해당 시스템에 Cobalt Strike Beacon을 설치

- 장악 : Cobolt Strike를 이용해 AD 장악
  - AD 도메인 구성 정보 확인
  - 취약점을 이용해 실행 권한 상승
  - 상승항 권한으로 Mimikatz 모듈 실행
  - AD 실행 관리자 계정을 획득하면 도메인 컨트롤러 서버에 접속해 도메인에 연결된 시스템 장악

- 실행 : AD 내 시스템을 대상으로 클롭 랜섬웨어 감염 시도
  - 도메인 콘트롤러의 공유 폴더에 클롭 등 악성코드 준비
  - AD 도메인에 연결된 시스템에 작업 스케쥴 또는 원격 명령을 이용해 클롭 배포 및 실행

<br>
<br>

- 전반적으로 클롭 랜섬웨어에는 큰 변화X, 약간의 변화 발생

암호화된 파일의뒷부분에 시그니처와 함께 공개키로 암호화된 `대칭키`가 덧붙여졌던 기존버전과 달리

2020년 하반기 수집된 클롭에서는 동일한 이름에 ".Clip" 확장자를 붙여 새로 생성한 파일에 `시그니처와 암호화된 키`를 지정함.

이랜드그룹 공격에 사용된 클롭도 이 방식으로 사용됨.

![image](https://user-images.githubusercontent.com/62640332/160268402-0e05fb9a-f093-43a4-8e34-e5ef3ed688ea.png)


![image](https://user-images.githubusercontent.com/62640332/160268409-1ad6f59e-63ec-47e7-9c37-1741ddbe5887.png)

FlawedAmmyy 등의 다른 악성코드들과 같이 Packer를 사용. 즉 파일 진달을 우회하기 위해 우너본 바이너리를 이놐딩해서 갖고 있으며 Packer가 실행되면서 메모리상에서 디코딩된 원본 바이너리를 실행함.

<br>

- 이랜드그룹 공격에 사용된 클롭의 특징

랜섬웨어가 댕치키 알고리즘을 이용해 각각의 파일을 암호화후 바이너리 내부에 존재하는 공개키로 대칭키를 암호화하여 해당 공개키에 상응하는 개인키를 알지 못하면 암호화된 파일들 복구 불가

다만 기존 발견된 클롭과 달리 볼륨 shadow copy 삭제 명령어가 없어서, 윈도 시스템에 랜섬웨어 감염 전 복원 지점이 존재하면 복원 기능을 이요하여 감염 전의 상태로 되돌리기 가능.

![image](https://user-images.githubusercontent.com/62640332/160268525-176d5c23-d69f-4857-8cae-5545f6a76796.png)

안랩은 이랜드그룹 공격한 클롭과 동일한 인증서를 가진 파일들 다수 획득.

분셕 결과에 따르면, 해당 인증서를 가진 또 다른 파일들은 2020년 10월  부터 유포되었고, 랜섬웨어 뿐 아니라 Windows Defender 안티바이러스 제품을 무력화하기 위한 파일로도 제작된 것으로 보아 동일 그룹이 동일한 이늦ㅇ서로 클롭 랜섬웨어 외에 다양한 악성코드 제작한것으로 추정.

<br>

- 시사점

클롭 일당의 랜섬웨어 공격 ㅘ정은 APT 공격 방식으로 랜섬웨어 배포. 이제 랜섬웨어 예방은 APT 대응 관점에서 접근할 필요 있음

클롭 일당이 표적 피싱, Packer의 사용, 합법적인 인증서의 사용, 상용 침투 테스트 도구의 사용등을 볼떄 정교한 방법으로 표적 공격하고 있음. 이에 대응위해 네트워크 내부에서 적절한 모니터링을 통해 합법적 도구의 비정상적 행위를 타밎할 수 있는 방안 마련



<br>
<br>
<br>

---

### ㅁ 솔라윈즈 SUNBURST 보안 해킹(공급망 공격)

SUNBURST는 SolarWinds의 IT 모니터링 및 관리 플랫폼인 Orion의 플러그인(SolarWinds.Orion.Core.BusinessLayer.dll)에 포함되어 있는 백도어

여러 트로이 목마 업데이트가 디지털 서명이 되어 SolarWinds 업데이트 사이트에 게시. 트로이 목마를 포함한 업데이트 파일은 합법적인 SOlarWinds.BusinessLayerHost.exe에 의해 악성 DLL이 로드됨

HTTP를 통해 타사 서버와 통신하고 2주의 휴먼 기간이 지나면 백도어에 파일 전송, 파일 실행, 시스템 프로파이일링, 시스템 재부팅 및 시스템 서비스 비활성화 지시하는 명령 실행


- 동작 방식
  - C2 서버에 접근하기 전에 SUNBURST는 분석 도구가 없는지 확인하기 위해 검사
  - SolarWidns.Orion.COre.BusinessLayer.dll의 파일시스템 마지막 쓰기 시간이 현재 시간보다 최소 12 ~ 14일 이전인 경우만 실행(2주간 휴먼 기간)
  - 시스템이 액티브 디렉토리 도메인이 가입되어 있는지 확인하고 해당하는 경우 도메인 이름을 검색(차단 목록에 대해 액티브 디렉토리 도메인 이름을 확인)
  - 시스템의 각 프로세스 이름, 서비스 이름, 드라이버 파일 이름의 해시를 계싼하고 차단 목록에 있는 프로세스나 드라이버 이름이 발견되면 SUNBURST는 일시 중지(포렌식 및 안티 바이러스 도구 식별)
  - SunBURST는 C2 코디네이터와 통신하기 위해 SUNBURST는 DGA(Domain Generation Altorithm)을 사용(avsvmcloud[.]com의 하위 도메인을 구성)
  - DGA 하위 도메인을 활횽해 맬웨어가 방어자의 표적이 되지 않도록 DNS 응답 변경
  - DGA는 다음 DNS 접미사를 사용하여 하위 도메인을 생성하여 FQDN(fully qualified domain names)을 만듦

```
.appsync-api.eu-west-1[.]avxvmcloud[.]com
.appsync-api.us-west-2[.]avxvmcloud[.]com
.appsync-api.us-ease-1[.]avxvmcloud[.]com
.appsync-api.us-ease-2[.]avxvmcloud[.]com
```
  - 차단 목록에 있는 프로레스 발견되면 업데이트 루틴 종료되고 차단 목록을 통과할떄 까지 루틴 실행을 계속 시도
  - 도메인이 성공적으로 검색되면 모든 C2 통신 및 디스패치를 담당하는 HttpHelper.Initialize 메소드를 홀추하느 새 실행 스레드 생성
  - HTTP 스레드는 HTTP GET 또는 HTTP POST 요청을 사용 각각의 명령을 실행
  - GET 요청을 보낼 떄 악성 코드는 인코딩된 사용자 ID를 포함하는 "if_None-Match" HTTP 헤더를 추가(C2 서버가 요청을생성한 SUNBURST 설치를 확인)
  - C2 서버는 스테가노그래피(steganography)를 사용해 HTTP 응답 본문 내의 데이터를 숨기고 인코딩된 응답을 HTTP 응답 본문으로 보내도록 함
  - C2 응답에서 첫 번쨰 DWORG 값을 메세지의 실제 클기를 나타내고 이 값 바로 뒤에 선택적 정크 바이트가 추가된 메세지가 옴. 추출된 메세지는 첫 번쨰 바이트를 사용하여 1바이트 XOR 디코딩 되도록 하여 선택적 추가 명령 인수와 함께 명령 DI에 매핑되는 ASCII 정수를 통하여 명령을 인식.

<br>

- 시사점

솔라윈즈 취약점 공격은 고도의 준비된 코드로 인하여 장기적을 이루어진 공격

<br>
<br>
<br>

---

### ㅁ MS 익스체인지 서버 취약점을 악용한 분석 사례

2021년 3월 마이크로소프트는 Exchange Server 보안 취약점 4개 패치 발표

CVE-2021-26855, CVE-2021-26857, CVE-2021-26858, CVE-2021-27065

이 보안 취약점들은 Exchange SErver에 대한 원격 코드 실행이 가능한 취약점으로서 CVSS 3.0 기준 Critical ~ High에 속하는 심각한 취약점

[자세한 추후 설명](https://github.com/sungmin4036/infomation_security/blob/main/Recent_Issue/%EB%A9%94%EC%9D%BC%20%EC%84%9C%EB%B2%84%20%EC%B7%A8%EC%95%BD%EC%A0%90.md)


<br>
<br>
<br>

---

### ㅁ 속닉월의 이메일 보안 솔루션의 제로데이 취약점

파이어아이(FireEye)는 소닉월의 이메일보안 솔루션인 SonicWall Email Security(ES)에서 필드에서 악용되고 있는 취약점 찾아내서 소닉월에 통보

  - CVE-2021-20021 Unauthorized administrative account creation (CVSS 9.8)
  - CVE-2021-20022 Post-authentication arbitrary file upload(CVSS 7.2
  - CVE-2021-20022 Post-authentication arbitrary file read(CVSS 4.9

<br>
<br>


- CVE-2021-20021 취약점

보안이 적절하게 되지 않은 API를 통해 인증 받지 안혹도 관리자 권한으로 접근 할 수 있는 취약점

소닉월 ES의 관리 기능 중 관리자가 별도의 마이크로소프트 Active Directory Organizaion Unit으로부터 추가로 관리자 권한을 부여할 수 있는 기능이 있는데, 여기서 기존 인증을 요구하지 않음.

![image](https://user-images.githubusercontent.com/62640332/160270099-dee6912d-5066-427c-82d2-9d570e9eb275.png)


이 취약점을 악용하면 공각자가 XML 문서를 조작하여 GET, POST로 애플리케이션에 보내 "role.ouadmin" 계정을 만든뒤, 그 계정을 애플리케시연에 관리자로 인증 받을수 있음.


<br>

- CVE-2021-20022

인증 후 '브랜딩' 기능을 통한 임의 파일 업로드 취약점

'브랜딩(branding)' 기능은 관리자가 회사 로고와 같은 특정 자산을 커스터마이즈 하여 인터페이스에 추가할 수 있는 기능. 이러한 자산을 포함한 ZIP 아카이브를 업로드해 새로운 패키지 만들기 가능.


![image](https://user-images.githubusercontent.com/62640332/160270144-9a915a28-222e-46e5-b5ab-c4504727bd5c.png)

이 떄 파일 유효성 검사가 부족하면 공격자가 웹쉘을 포함한 임의의 파일을업로드 가능.

또한 브랜딩 패키지는 소닉월이 지정한 곳으로만 파일을 업로드 하게 되어 있으나, 실제로는 공격자가 악성코드를 톰캣 디렉토리와 같은 임의의 디렉토리에 설치 가능

<br>

- CVE-2021-20023

인증 후 브랜딩 기느에서 디렉토리 트래버설(Traversal) 취약점으로 인한 임의 파일 읽기 가능

공격자가 특정한 리소스에 조작된 HTTP GET 요청을 보내면 호스트에서 임의의 파일을 읽을 수 있음

![image](https://user-images.githubusercontent.com/62640332/160270187-10949169-151c-4d48-b318-a7c8914087b7.png)

이 브랜딩 기능의 작업 디렉토리는 `<SonicWall ES install path>\data\updates` 이지만, 이 요청을 처리하는 톰캣 서버가 AUTHORITY\SYSTEM 계정으로 작동하고, 디렉토리 트래버설 취약점이 있어서 공격자가 운영체제의 모든 파일에 접근 가능.

- 공격자가 3가지 취약점을 이용하여 악성행위 하였음

1. 소닉월 ES 디바이스에 새 관리자 계정 생성
2. 기존 관리자 계정 비밀번호 노출
3. 임의의 디렉토리에 웹쉘 생성
4. 공격 성공과 실패에 대한 실시간 디버깅

<br>
<br>
<br>

---

### ㅁ 펄스시큐어 VPN에 대한 사이버 공격 활발

공격자의 활동이 펄스시큐어 VPN 어플라이언스에 속하는 DHCP IP 주소 범위로 추적됨

일부 침입은 2019년과 2020년에 공개된 펄스시큐어 VPN의 취약점 악용한것, 다른 침입은 CVE-2021-22893을 악용한 것으로 의심

-  공격자가 수행한 공격

1. 악성코드르 이용해 공유 객체(SHared objects)를 트로이 목마(SLOWPULSE 및 그 변종)로 만들어 자격증명을 로깅하고 다중 인증을 우회
2. 웹쉘(RADIALPULSE, PULSEXCHECK)을 펄스시큐어 VPN 어플라이언스 관리 웹 페이지에 삽입
3. 파일시스템을 읽기 전용 모드와 읽기-쓰기 모드 사이에 전환하여 읽기 전용 파일 시스템에서 파일 수정을 허용
4. 관리자가 수행하는 VPN 어플라이언스 업그레이드 전반에 걸쳐 지속성 유지
5. 탐지를 피하기 위해 변경된 파일의 패치를 제거하고, 사용한 유틸리티와 스크립트를 삭제
6. 공격자가 정의한 정규식을 기반으로 유틸리티(THINBLOOD)을 사용하여 관련 로그 파일을 삭제

- SLOWPULSE 악성코드

1. 해커그룹 UNC2630을 조사하면서 SLOWPULSE라는 새로운 악성코드군이 발견됨. 이것은 적법한 펄스시큐어의 파일의 변형으로 적영되며, 이를 통해 공유 객체 libdsplibs.so 내의 인증 과정에서 자격증명을 우회하거나 로깅함.
2. 발견된 4가지 변종 중 3가지는 공격자가 이중 인증을 우회할 수 있도록 해줌
3. SLOWPULSE Variant 1 : 공격자가 비밀 백도어 암호를 제공하면 LDAP 및 RADIUS-2FA 인증 루틴을 우회하는 역할을 함

![image](https://user-images.githubusercontent.com/62640332/160270894-9bc39fe5-ac96-4416-82b3-12d4ea20b763.png)


LDAP 우회 : LDAP 인증 절차에 비밀번호에 대한 검사를 삽입하여 공격자가 제공한 백도어 비밀번호와 일치하면 인증이 성공한 것으로 조작함.

![image](https://user-images.githubusercontent.com/62640332/160270916-6d578f98-a1e9-4267-9718-39975f567952.png)

RADIUS 이중 인증 우회 : 인증 서버에서 RADIUS 인증 패킷을 수신한 뒤 프로세스에 비밀번호에 대한 검사를 삽입하여 공격자가 제공한 백도어 비밀번호와 일치하면 패킷 이중 인증을 우회하기 위해 패킷 유형과 인증 상태 플래그를 조작함.

<br>
<br>
<br>

---

### ㅁ FireEye, DarkSide 연계 조직 활동 파악

 다크사이드(DarkSide)의 연계 조직인 UNC2465가 침입하는 것을 관찰했다고 밝힘.

 UNC2465는 CCTV 보안 카메라 제공 업체인 SmartPSS 웹 사이트에서 두개의 소프트웨어 설치 패키지를 트로이목마로 만들었을 가능성 있음.

 ![image](https://user-images.githubusercontent.com/62640332/160271053-1493b910-530d-44cc-a3c2-752a6c2e6823.png)


 1. 인스톨러 트로이목마 다운로드

피해 조직이 사용한 합법적인 사이트에 사용자가 방문한 뒤 윈도시스템에 트로이목마로 만들어진 인스톨러가 다운로드됨.

다운로드된 파일의 압출을풀면 다음 파일이 생성됨

![image](https://user-images.githubusercontent.com/62640332/160271123-e4031d25-50c3-45c0-8d3d-588de6013c1b.png)

2. Nullsoft Installer

이 인스톨러 실행 파일은 Nullsoft installer 인데, 실행하면 두 파일이 생성됨. General.exe , smartpss.exe

앞의 실행 파일은 원 개발자가 개발한 문제 없는 인스톨러이고, 뒤의 실행 파일(smartpss.exe)은 컨텐트를 싱행하는 command line URL

이 smartpss.exe.에는 자신이 MSHTA.exe(Windows 운영체제 구성 요소 중 하나)라고 쓰인 메타 데이터가 있고, 실제로 mshta.exe와 같은 동작을 함.

3. 다운로드된 VBScript와 PowerShell
   
smartpss.exe.가 실행될 떄 다음과 같이 특정 URL을 command line의 인수로 전달함.

![image](https://user-images.githubusercontent.com/62640332/160271235-b31a0316-b73f-412d-b2c9-9a1e936217da.png)

실행 결과로는 일부 내용이 다음과 같은 loubSi78Vgb9[1]라는 HTM 파일이 생성됨.

![image](https://user-images.githubusercontent.com/62640332/160271254-64d8822a-72e1-4f9a-a4af-654d182b447d.png)


다운로드된 그림과 같이 곧 PowerShell 스크립트 블록이 실행되어 SMOKEDHAM을 다운로드함.

![image](https://user-images.githubusercontent.com/62640332/160271273-407ac578-e02b-41db-9a6f-584a0800b4a7.png)

4. SMOKEDHAM 드로퍼(Dropper)

SMOKEDHAM 드로퍼는 POwerShell로 작성되어 SMOKEDHAM 백도어를 복호화하고 메모리에서 실행

SMOKEDHAM 백도어 소스는 암호화되어 삽입되어 있는데, PowerShell의 ConverTO-SecureString cmdlet과 삽입된 키를 이용해 이 소스를 복호화함. 또한, 드로퍼는 백도어에 C2 서버 주소, RC4 암호화키 ,. sleep 주기를 설정.

5. SMOKEDHAM 백도어

SMOKEDHAM은 .NET 기반의 백도어로서 화면 캡처 및 키입력 캠처 등의 명령어를 지원함. 또한 C2 서버에서 추가 PowerShell 명령을 받아 실행 가능.

SMOEKDHAM은 https를 사용하여 C2 서버와 통신

6. 후속 활동

SMOKEDHAM은 파일 공유 사이트에서 원격제어 도구인 UltraVNC(winvnc.exe)와 그것이 설정 파일인 UltraVNC.ini 다운로드 함.

SMOKEDHAM은 파일 공유 사이트에서 NGROK 유틸리티(conhost.exe)와 NGROK를 실행하는데 사용되는 VirtualHost.vbs 스크립트 다운로드.

NGROK는 NAT 및 방화벽 뒤의 서버를 보안 터널을 통해 공용 인터넷에 노출할 수 있는 공개 유틸리티.

키로거는 C:\ProgramData\psh\console.exe가 사용됨. 이것은 키 입력을 캡처하여 C:\ProgramData\psh\System32Log.txt에 기록하도록 구성


<br>
<br>
<br>

---

### ㅁ 원격접근 방법의 취약점

- 대응 방법 : SSL_VPN 솔루션을 최신 패치 상태 유지, 2차 인증(MFA) 적용

![image](https://user-images.githubusercontent.com/62640332/160271730-3eab5278-3dee-416b-b87f-835cd12decb9.png)

SSL-VPN의 연결은 SSL-VPN 전용 솔루션 또는 방화벽에 포함된 SSL-VPN 기능을 주로 이용하며, 내부 네트워크에 대한 접근을 가증하게 해주는 게이트웨이 역할을 하기 때문에 SSL-VPN 솔루션의 취약점의 내부 자원에 대한 접근통제에 심각한 문제를 유발할 수 있게 된다.

포티넷의 SSL-VPN 기능에서 노출된 경로 변경 취약점(CVE-2018-13379)과 대표적인 SSL-VPN 전용 솔루션인 펄스시큐어 커넥터의 임의 파일 공개 취약점(CVE-2019-11510)은 공개된지 1년이 넘었지만 2021년 상반기까지도 패치가 적용되지 않은 시스템을 대상으로 공격이 지속되고 있다.

노출된 경로 변경 취약점(CVE-2018-13379)은 "/remote/fgt_lang?" 페이지 호출시 lang 매개변수의 필터링을 제대로 수행하지 못해 발생하는 취약점으로

간단히 매개 변수의 중간에 삽입하여 전송함으로써 해당 장비의 ID와 Password를 알아낼 수 있따.

아래 그림은 포티넷의 로그인 페이지로, 쇼단 등의 사이트를 통해 쉽게 정보 구할수 있다.

![image](https://user-images.githubusercontent.com/62640332/160272440-c5ecbcb6-6015-4ddf-874b-51b6ea059fcb.png)

로그인 페이지 호출시 아래 그림과 같이 프락시 도구 등을 이용해 경로 취약점 공격을 위한 페이로드를 쉽게 삽입할 수 있으며, 이는 초보자들도 쉽게 행할 수 있는 수준.

![image](https://user-images.githubusercontent.com/62640332/160272473-bc42e299-24a9-42d0-8521-870f3ca3758c.png)

취약점에 노출된 

FortiOS 5.4 - 5.4.6 to 5.4.12

FortiOS/5.6.3 ~ 5.6.7

FortiOS/6.0.0 ~ 6.0.4

위의 경우 그림3과 같이 로그인 페이지의 호출 시 경로 취약점 공격을 위한 페이로드를 삽입할 경우 그림4 와 같이 해당 솔루션의 ID와 패스워드 찾을수 있으며, 이렇게 확인한 크리덴셜 정보를 이용하여 해당 솔루션 정상적으로 로그인을 할수 있게 된다.

![image](https://user-images.githubusercontent.com/62640332/160272999-559a13a1-4599-4beb-9031-dbb5e2c6c956.png)

위의 사례는 웹 기반의 인터페이스를 제공하는 SSL-VPN 솔루션들에서 HTTP의 요청을 제대로 검증하지 않음으로써 발생.

![image](https://user-images.githubusercontent.com/62640332/160273035-cc022ece-5388-4752-a86a-f9c16d2b4486.png)



<br>
<br>
<br>

---

### ㅁ 스마트폰 앱 취약점

- 취약대상 및 발생 가능성 위협 : 삼성 스마트폰 SMR APR-2021 Release 1 이전 버전을 사용하는 이용자의 정보 탈취 및 "혹스" 메일 등의 협박에 대한 노출

- 대응 방법 : 최신 펌웨어로 업데이트 적용

- 사고시나리오 : 제조사에 의해 사전 배포된 앱의 취약점을 이용하여 임의의 앱 설치 및 관리자 권환획득을 통해 파일 및 정보의 삭제 및 유출이 가능.


![image](https://user-images.githubusercontent.com/62640332/160273153-bcd7129a-8e09-4192-9a4d-7d434312c0a5.png)

Knox의 버그로 알려진 CVE-2021-25388는 악성 앱을 설치하는데 악용될수 있으며, 삼성 Dexc의 버그는 앱과 메세지 등에서 발생하는 알람에서 데이터를 수집하는 용도로 사용될 수 있다.

특히 Managed Provisioning은 모든 Samsung 장치에 사전 설치된 앱이며 기업 장치 사용자 지정에 사용되는데 타사 앱의 설치 및 기기관리자 권한을 획득할 수 있는 심각한 취약점(CVE-2021-25356) 발생

![image](https://user-images.githubusercontent.com/62640332/160273476-cc9b19c1-8a21-4482-a922-78bb8d3ad827.png)

오리지날 Managed Provisioning 앱은 AOSP에 의해 개발 되었으며 모드누 상호작용에 대해 보안 검수를 통해 승인되었다.

그러나 삼성에서는 에코시스템과 Knox 코어와 상호기능을 추가하기 위해 Managed Provisioning app을 수정했다.

따라서 Samsung 앱에서 그림과 같인 com.samsung.knox.container.requestld 값의 설정을 통해 상호작용 검사 과정을 건너뛸수 있다.

![image](https://user-images.githubusercontent.com/62640332/160273523-9d104627-1356-4339-ba3e-8417c1909bfd.png)

Managed Provisioning 설정을 위해 필요한 표준 파라미터들을 패싱하고 ProvisioningParams.Builder 클래스의 코드를 복사함으로써 사용자 앱들이 설치하고 기기 관리자 권한을 부여할 수 있다.

그림은 앱을 다운로드하기 위한 URL과 파일의 Sha1 패시값 그리고 시스템에서 전송한 원시 인텐트 작업을 해석하는 기기 관리자 구성요소 구현하기 위한 기본 클래스인 DeviceAdminReceiver를 설정한다.

![image](https://user-images.githubusercontent.com/62640332/160273568-83a678e0-3cf9-45c5-b820-e7b31057aa29.png)

Managed Provisioning 취약점(CVE-2021-25356)에 대한 공격 코드가 적용 되고 나면 그림과 같이 3단계의 같은 결과 얻을수 있다.

![image](https://user-images.githubusercontent.com/62640332/160273655-8d8b0d43-095e-4c93-8ac7-1290fbef4a27.png)

<br>
<br>
<br>

---

### ㅁ 랜섬웨어

- 대상의 변화 : 주로 개인 pc, 관리되지 않는 기업 시스템 -> 기업, 공공기관, 사회기반시설

- 공격 기법의 고도화 : 피싱 이메일, 감염된 웹 사이트 -> 원격 데스크톱, 알려진 소프트웨어 취약점 악용

- 서비스형 랜섬웨어(RaaS, Ransomware as a Service)의 활성화 : 랜섬웨어가 전문 조직에 의해 제작되어 판매되면서 전문지식이 없는 공격자도 비용만 지불하면 랜섬웨어 공격을 할 수 있도록 서비스형으로 진화 되었다. 

- 랜섬웨어 공격 기법 - MITRE ATT&CK 프레임워크로 전술 구분

1. 초기 접근(Initial Access) : 랜섬웨어 공격에서 초기 접근 기법으로 가장 널리 사용되는 것은 원격 서비스. 원격 서비슨느 랜섬웨어 뿐만 아니라 최근 침해사고의 가장 큰 위험을 자리 잡고 있다.(재택 근무에 의해서)

다음으로 외부에서 접근 가능한 공개 응용프로그램의 취약점을 악용하는 비율이 높은데 공격자가 직접 악용하기 보다든 이미 악용해 네트워크 접근을 확보한 써드파티로 부터 구매해 사용하는 경우가 많다.

사용되는 취약점으로는 기술적인 취약점 이외에 접근제어 설정이 미흡하거나 공장 출하시 설정된 기본 관리자 크리덴셜을 변경없이 사용하고, 보안 업데이트 적용하지 않아 알려진 취약점에 악용되는 관리적인 취약점도 많은 비율을 차지.

그 밖에도 공문서, 이력서, 견적서 등으로 위장한 피싱 이메일, 하드웨어 추가, 신뢰할 수 있는 관계를이욯나 공격 등 널리 사용됨.

특히 피싱 이메일은 상대방이 신뢰할 수 있또록 이메일 스캠 공격을 사용되는 스레드 하이재킹 기술이 보편적으로 사용.

   - External Remote Service
   - Exploit Public-Facing Application
   - Phishing
   - Hardware Additiions
   - Trusted Realationship

2. 실행(Execution): PowerShell, Command Shell, Visual Basic, JavaScript/Jscript 등의 명령 스크립트 활용하는 비율 가장 높음.

다음으로 Native API를 활용해 프로세스 삽입 시도하거나

작업 스케줄러나 시스템 서비스를 등록해 랜섬웨어를 실행하는 기법사용

그리고 취약점을 사용하지 않는 경우, 여전히 사용자의 실행을 유도해 랜섬웨어를 배포하고 WMI를 이용해 원격 호스트의 랜섬웨어를 실행하는 방법 사용

   - Command and Scripiting Interpreter
   - Native API
   - Scheduled Task/Job
   - System SErvices
   - User Execution
   - Windows Management Instrumentation

3. 지속(Persistence) : 랜섬웨어를 실행하기 전 까지 공격자는 지속성 매커니즘을 사용해 계속적으로 공격 단계 진행.

많이 사용되는 지속성 매커니즘은 레지스트리 실행 키나 시작 폴더를 사용하는것 부터 

작업 스케줄러 이용하거나 이미 획득한 자격증명으로 정상 로그온을 통해 공격을 진행하는 기법

추가적인 계정을 생성하는 기법, 윈도우 서비스 생성하거나 수정하는 기법

WIM 이벤트 구독을 악용하거나 Shim 데이터베이스를 변경해 이벤트를 트리거 하는 방법등 많이 사용

   - Boot or Logon Autostart Execution
   - Scheduled Task
   - Valid Accouints
   - Create Account
   - Create or Modify System Process
   - Event Triggered Execution
   - Hijact Exercution Flow

4. 권한 상승(Privilege Escalation) : 랜섬웨어 공격자도 랜섬웨어의 실행, 시스템 백업 삭제, 정보 수집, 내부망 이동 등을 위한 권한 상승 필요

주로 프로세스 할로윙(Hollowing)이나 DLL 인젝션 등을 이용한 프로세스 인젝션 기법과

지속 매커니즘에서 사용했던 자동 실행 기법, 작업 스케줄러 악용, 유효한 계정을 이용한 공격이 많이 사용.

그밖에 AUC(User Access Control)을 우회하거나 권한 상승 취약점을 이용하기도 한다.

   - Process Injection
   - Boot or Logon Autostart Execution
   - Scheduled Task/Job
   - Valid Accounts
   - Avuse Elevation Control Mechanism
   - Exploitation for Privilege Escalation

5. 방어 회피(Defense Evasion) : 랜섬웨어 공격자들은 랜섬웨어를 실행하기 전까지 최대한 공격을 은닉하려고 한다.

많이 사용하는 방어 회피 기법으로는 데이터를 낙독화 하거나 인코딩해 숨기고 보안 및 로깅 서비스를 변경해 로그를 남지 않도록 하거나 예외 폴더를 이용해 백신의 진단을 우회한다.

또한, 파일/폴더의 권한을 수정해 노출을 최소화하고 NTFS ADS(Alternative Data Stream)을 이용해 데이터를 은닉하거나 정상 파일인 것처럼 위장하고  서명된 바이너리를 이용해 실행 검증을 우회하는 방법 많이 사용

   - Deobfuscate/Decode Files of Information
   - Impair Defenses
   - Masquerading
   - Obfuscated Files or Information
   - Signed Binary Proxy Execustion
   - BITS Jobs
   - Indicator Removal on Host

6. 자격 증명 접근(Credential Access) : 랜섬웨어 공격자는 초기 침투 후 유효한 자격증명을 얻기 위해 Password Guessing, Password Spraying, Credential Stuffing을 사용하고 로컬 시스템의 저장소(레지스트리, 응용프로그램 파일 등)에서 사용자가 저장한 자격증명을 획득하려고 시도한다.

또한 사용자의 입력을 캐려하거나 사용자 로그온 인증시 생성되는 메모리 상의 자격증명을 덤프해 유효한 자격증명을 획득.

   - Brute Force
   - OS Credential Dumping
   - Credentials from Password Stores
   - Input Capture

7. 발견(Discovery) : 랜섬웨어 공격자들은 기업 네트워크에 침투하면 먼저 AD(Active Directory)의 사용 여부를 체크한후 AD 정보를 수집하는데 집중한다.

이후 네트워크 스캐닝 도구로 내부 네트워크를 파악하거나 시스템 정보 및 파일/폴더를 지속적으로 조사해 추가적인 내부망 이동 정보를 획득하거나 유출할 중요 데이터를 선별한다.

   - Account Discovery
   - Remote System Scanning
   - Network Service Scanning
   - System Infomation Discoery
   - File and Directory Discovery
   - SYstem Owner/User Discovery
   - Network Share Discovery
   - Process Discovery
   - System Service Discovery

8. 내부망 이동(Lateral Movement) : 서비스형 랜섬웨어가 일반화되면서 내부망 이동을 통한 랜섬웨어 전파가 일반화 되었다. 내부망 이동에는 EternalBlue, Zerologon 등의 원격 서비스 취약점을 이용하거나 PTH(Pass-the Hash), PTT(Pass-The Ticket)와 같은 대체 인증 수단을 악용해 원격 시스템에 랜섬웨어 배포한다.

또한, PsExec, BITS(Background Intelligent Transfer Service), RDP, SMB/Winds Admin Share, DCOM(Distriburted Component Object Model), WinRM(Winodws Remote Management) 등을 악용해 랜섬웨어를 전송하고 실행

   - Lateral Tool Transfer
   - Remote Services
   - Use Alternate Authentication Material

9. 수집(collection) : 최근 랜섬웨어 공격자들은 데이터 암호화와 함께 몸값 협상을 유리가헤 이끌기 위해 중요 데이터 유출한다.

감염시킨 로컬 시스템이나 공유 드라이브에서 민감한 데이터를 수집해 WinRAR 이나 7-z 으로 압축해 유출하는 기법이 많이 사용

   - Archive Collected Data
   - Data from Local System
   - Data from Network Shared Drive

10. 명령제어(Command and Control) : 랜섬웨어 공격자들도 최근에는 상용 악성코드나 프레임워크를 주로 사용해 HTTP나 HTTPS를 사용한 랜섬웨어 공격이 다수를 이루고 있다.

그 밖에 상용 악성코드에서 자체적으로 제공하는 대칭키/비대칭키 방식의 암호화 채널을 이용하거나 데이터 인코딩, 데이터 난독화 기법을 사용해 명령 제어 채널을 유지한다.

주목할 만한점은 다른 사이버 공격과 마찬가지로 랜섬웨어 공격도 현재 유지하고 있는 C2 채널의 차단에 대비해 2차, 3차의 보조대체 C2 채널을 이용하거나 확보해둔다.

  - Application Layer Protocol
  - Encrypted Channel
  - Data Encoding
  - Fallback Channel
  - Mul_Stage Channel
  - Ingress Tool Transfer
  - Remote Access Software
 
11. 유출(Exfiltration) : 많은 랜섬웨어 공격자는 보안 제어를 우회하기 위해 데이터를 여러 조각으로 나누어 유출한다.

유출에 사용되는 서비스는 자체 구축한 웹 서비스를 사용하거나 널리 알려진 클라우드 스토리지를 웹 기반으로 접근한다.

감염 호스트에 클라우드 서비스 클라이언트 프로그램을 설치하는 대범한 공격자도 종종있다.

  - exfiltration Over Web Service
  - Data Transfer Size Limits
  - Transger Data to Cloud Account


12. 영향(Impact) : 많은 랜섬웨어의 주된 목표는 데이터 암호화

데이터 암호화의 효과를 높이기 위해 암호화 전/후 데이터를 복원할 수 있는 시스템 백업을 삭제해 복구가 불가능하도록 한다.

이를 위해 대부분 랜섬웨어는 윈도우 시스템 복원 기능인 볼륨 새도 복사돈(Volume Shadow Copy)를 삭제하는 명령이 내장되어 있따.

최근에는 시스템 거부를 통해 몸값을 요구하는 랜섬 DDoS 공격도 발생하고 있다.

  - Encrypt Data for Impact
  - Inhibit System Recovery
  - Network Denial of Service

  
<br>
<br>

- 랜섬웨어 대응 방안

1. 모든 소프트웨어 최신 패치 및 업데이트 적용
2. 가능한 2단계 인증 및 암호화 사용
3. 효과적인 백업 및 재해복구 대책 마련
4. 직원에게 최신 사이버 위협과 이를 방지하기 위한 방법 교육
5. 사이버 보안 정책의 모범 사례를 개발하고 실행

<br>
<br>

---

ㅁ 최근 기업 대상 랜섬웨어 사고사례 분석

### ㅁ 비트라커(BitLocker)

: 파일 업로드 취약점을 이용한 웹셸 업로드, 권한상승 도구를 통한 시스템 권환 획득 이후 윈도우 서버 자체 내장 기능인 비트라커를 싱행하여 디스크를 암호화하고 금전을 요구하는 공격 발생

- 사고원인: 파일업로드 취약점
- 해킹경로: 웹셸 업로드 후 권한상승 도구를 이용하여 악성코드를 설치하고 디스크를 암호화

![image](https://user-images.githubusercontent.com/62640332/160282805-e55e807a-9889-486d-b616-01861114d3ea.png)

- 원인 
  - 미패치된 웹 게시판 및 운영체제 사용
  - 파일업로드 디렉토리의 실행권한 부여 및 상위 디렉토리 접근 허용 등 부적절한 정책 설정
  - 중요 서버에 일반직원 접근 가능


- 주요 공격 단계

1. Initial Access(최초 침투) : 웹 취약점을 이용해 웹셸을 업로드하고 업로드한 웹셸을 이용해 또 다른 웹셸을 업로드하여 침투 기반을 마련
2. Privilege Escalation(권한 상승) : 웹셸을 이용해 윈도우 운영체제에서 시스템 권한을 획득할 수 있는 도구를 업로드한 후 권한 상승 도구 실행으로 시스템 권한 획득
3. Credential Access(계정정보 확보) : 원활한 원격접속을 위해 획득한 시스템 권한을 이용하여 계정을 생성하고 생성한 계정을 관리자 그룹에 추가.
4. Defense Evasion(추적회피) : 자신의 침입이 탐지되는 것을 피하기 위해 웹셸을 이용해 윈도우 권한 상승 도구 삭제
5. Persistence(지속성 유지) : 해킹된 시스템에 접속할 수 있는 경로 차단에 대비해 원격제어용 악성코드 설치
6. Impact(디스크 암호화) : 윈도우 운영체제에 내장된 디스크 암호화 기능(비트라커)을 이용하여 디스크를 암호화하고 복구를 대가로 금전을 요구


<br>

---


- 침투 단계별 상세 내용 및 대응 전략

1. Inittial Access : 최초 침투

ㄱ. 웹 취약점을 이용한 웹셸 업로드

공격자는 모 기업의 홈페에지 '고객상담' 게시판의 파일(이미지, 문서 등) 첨부 기능을 이용해 첫번쨰 웹셸(test.cer)을 업로드

업로드 한 웹셸은 시스템 정보 유출, 내부 취약점 서비스스캔 드의 악의적인 행위가 가능하도록 공격자의 명령어 전달하는 역할

![image](https://user-images.githubusercontent.com/62640332/160283247-5fb4d3df-ab37-442e-97ea-c94e0be7373d.png)

- 파일 업로드 취약점 보완
  - 오픈소스 게시판 보안 패치
  - 파일 업로드 제한(확장자 등)
  - 업로드 파일 저장 시 파일명 변경

<br>
<br>

ㄴ. 업로드 한 첫 번쨰 웹셸을 이용해 또 다른 웹셀 2차례(2종) 업로드

공격자는 첫 번쨰 업로드한 웹셸(test.cer)을 이용해 또 다른 웹셸(info.asp)을 업로드하고 이 웹셸(info.asp)을 이용해 다른 웹셸(cate_into1.aspx)을 추가로 업로드.

자신이 업로한 첫 번째 웹셸이 관리자 또는 백신에 의해 삭제되는 것에 대비해 추가적으로 웹셸(2종)을 업로드한것으로 추정

![image](https://user-images.githubusercontent.com/62640332/160283363-988ca7f8-4068-43c2-9620-6fb313ecc60a.png)

![image](https://user-images.githubusercontent.com/62640332/160283404-2034cc19-5aee-4242-8c9e-bc7637e4d0b0.png)

- <대응방안> 파일 업로드 디렉토리 실행권한 제거 
  - 웹셸 파일이 업로드 되더라도 실행할 수 없도록 권한 제한
  
    [IIS 웹서버 파일 업로드 디렉토리 "실행" 권한 제거 방법]   
    h 업로드 폴더 우클릭 > 등록 정보 > 디렉토리 > 실행 권한 "없음" 설정

    [Apache 웹서버 파일 업로드 디렉토리 "실행" 권한 제거 방법]   
    
    ① Apache 설정파일(/etc/httpd?conf/httpd.conf) 수정
    
    ```
    <Directory "/usr/local/apache">
    AllowOverride FielInfo
    </Directory>
    ```
    ② 파일 업로드 디렉토리에 .htaccess 파일 생성 및 아래 내용 작성

    ```
    <.htaccess>
    <FilesMatch "\.(ph|inc|lib)"> Order allow, deny
    Deny from all
    </FilesMatch>
    AddType text/html .html .htm .ph .php .php3 .php4 .phtml .phps .in .cgi ,pl .shtml .jsp
    ```

<br>
<br>

2. Privilege Escalation : 권한상승

ㄱ. 웹셸을 이용해 권한상승 도구 업로드

윈도우 운영체제에서 시스템(System) 권한을 획득할 수 있는 도구(SweetPotato)를 웹셸(info.asp)을 이용해 업로드 후 관리자 모니터링 및 백신탐지 우회 등의 목적으로 파일명을 변경

   - 웹셀(info.asp)을 이용해 윈도우 권한상승 도구(SweetPotato)업로드

    ![image](https://user-images.githubusercontent.com/62640332/160283694-a70698c1-9da5-4242-8ee8-d8ce421ba9a9.png)

    - <대응방안> 상위 디렉토리 접근 제한 
      - IIS 7.0의 경우
      ① 인터넷 정보 서비스(IIS) 관리자 > 해당 사이트 > IIS > ASP
      ② "부모 경로 사용" 항목을 False로 설정
  

ㄴ. 권한상승 도구 실행으로 시스템 권한 획득

시스템 권한 획들을 위해 권한 상승 도구(SweetPotato)를 실행하였다.

![image](https://user-images.githubusercontent.com/62640332/160283845-579f2104-f2f4-4535-bc9b-3d5fcc4bdc8b.png)

   - <대응방안> 비정상 파일 생성여부 모니터링 
     - 윈도우 운영체제에서 공격자가 권한상승 도구를 업로드 하는 폴더에 비정상 파일 생성 유무 주기적 점검
       - C:\ProgramData 폴더 등에 비정상 파일 생성유무 점검.

\# 윈도우 운영체제의 서비스 계정 권한에서 SYSTEM 권한으로 상승할수 있게 해주는 대표적인 도구로 JuicyPotato, RottenPotato, RoguePotato 등이 있으며, 이사고에서 공격자가 웹(IIS) 권한에서 SYSTEM 권한으로 상승하여 관리자 계정을 생성하여 악용

<br>
<br>

3. Credential Access : 계정확보

공격자는 원격에서 시스템 내부에 쉽게 접근 위해 웹셸(Cate_into1.aspx)을 이용해 계정(test)을 생성하고, 생성한 계정을 관리자 그룹에 추가.

![image](https://user-images.githubusercontent.com/62640332/160283974-918b102a-ced5-420e-b4c5-0a6598a9f98a.png)

- <대응방안> 비정상 계정 생성여부 모니터링 
  - 사용하지 않는 비정상 계정 생성 여부 모니터링
    - 확인방법 : 명령어프롬포트(cmd)에서 'net user' 입력


<br>
<br>

4. Defense Evasion : 추적 회피

공격자는 자신의 ㅎ랭위를 은폐하기 위해 웹셸(info.asp)을 이용하여 권한상승 도구 파일(sdfp.exe)을 삭제


![image](https://user-images.githubusercontent.com/62640332/160284050-dc81531e-da45-4be4-aa11-a7cb1e4c7de5.png)

- <대응방안> 비정상 파일 생성여부 모니터링
  - 윈도우 운영체제에서 공격자가 권한상승 도구를 업로드 하는 폴더에 비정상 파일 생성 유무 주기적 점검
    - C:\ProgramData 폴더 등에 비정상 파일 생성유무 점검

<br>
<br>

5. Persistence : 지속성 윰지

공격자는 최초 침투 서버를 거점으로 삼기위해 원격데스크톱으로 부정 접속(test 계정)하고 원격제어용 악성코드 설치 및 계정정보를 수집을 위한 도구를 실행

ㄱ. 생성한 test 계정을 이용해 원격 데스크톱 접속, 웹셸의 'PortMap' 기능을 이요한것으로 판단.

![image](https://user-images.githubusercontent.com/62640332/160284120-314bbe16-b102-42c2-8a16-ff14d4f2ffe6.png)

\# Plug: 원격제어형 악성코드의 한 종류로서 3가지가 조합된 형태(정상 프로그램(EXE), 악성 DLL모듈, 암호화된 데이터 파일)로 배포 되며 명령조종지(C&C)로 부터 명령을 받아 프로세스 목록, 키보드 입력 값, 화면 캡쳐 등의 정보 유출

![image](https://user-images.githubusercontent.com/62640332/160284202-cad1a22f-9e7d-4ef0-b1f2-b0987f837c55.png)

- <대응방안> 백신 실시간 기능 활성화
  - 서버 및  PC에 백신을 설치하고 실시간 감시 기능 실행 및 자동업데이트 설정

6. impact :  디스크 암호화

공격자는 test 계정을 이용해 원격데스크톱 접속 후 윈도우 운영체제의 기본 디스크 암호화 기능인 비트라커를 이용해 디스크를 암호화 하였다.

![image](https://user-images.githubusercontent.com/62640332/160284309-6746fcff-9fc1-45b5-a74a-357980e2f4c0.png)

- <대응방안> 오프라인 백업
  - 온라인으로 연결된 백업서버까지 암호화 되어 복구를 하지 못한 사례가 다수 있으므로 중요 자료도 별도 오프라인 백업 필요


<br>
<br>
<br>

---

### ㅁ 아바돈(Avaddon) 랜섬웨어

: 인터넷으로 연결된 지방지사의 관리자 PC가 악성 이메일을 열람하여 악성코드에 감염되고, 측면이동9Lateral Movement) 등의 기법을 통해 Active Directory(AD) 서버가 장악.   국내,외 서버 및 단말기가 감염되는 사고 발생

- 사고원인: Administator 계정 탈취로 인한 랜섬웨어 감염
- 해킹경로: 지사 서버 해킹을 통해 AD 도메인 컨트롤러 서버로 접근, 랜섬웨 배포

![image](https://user-images.githubusercontent.com/62640332/160284454-831fcb26-d19a-4919-b7d4-c512bdc789fe.png)

- 원인
  - 악성 이메일 열람
  - 중요 관리자 PC의 인터넷 사용
  - 불필요한 AD 관리자 그룹 계정 사용


- 주요흔적

![image](https://user-images.githubusercontent.com/62640332/160284493-a193dfe6-4efc-4d67-a391-826ed54d5311.png)

- <대응방안>
  - 악성 이메일 대응체계 강화(훈련, 교육 등)
  - 주요 관리자 PC 인터넷 접속 차단, 망분리
  - AD 관리자 그룹 계정 최소화
  - 최신 보안패치 적용

<br>
<br>
<br>

---

### ㅁ 다르마(Dharma) 랜섬웨어

: 일반적인 PC가 해킹되어 감염 거점 으로 활용되었으며, IDC에 위치한 본사 WEB, DB 서버로 추가적으로 침투, 랜섬웨어에 감염되는 사고 발생

- 사고원인: 서버 접근제어의 미설정으로 인해, 원격데스크톱으로 침투 후 랜섬웨어 감염
- 해킹경로: 일반직원 PC를 통해 각 서버로 원격 접속하여 랜섬웨어 실행

![image](https://user-images.githubusercontent.com/62640332/160284597-99f601a0-f2b0-406a-9429-4091adef3568.png)

- 원인
  - 원격접속 허용
  - 쉬운 패스워드 사용
  - 중요 서버에 일반직원 접근 가능

- 주요 흔적

![image](https://user-images.githubusercontent.com/62640332/160284626-addddd7d-d7d6-4057-a2a3-72bcecad08d5.png)

- <대응방안>
  - 불필요한 원격접속 비활성화
  - 패스워드 보안 강화(이중인증)
  - 중요 서버에 관리잠나 접속하도록 IP 접근제어 설정
  - 오프라인 백업


<br>
<br>
<br>

---

![image](https://user-images.githubusercontent.com/62640332/160285062-2815bc27-695f-4e7f-99df-132fe073e48a.png)

![image](https://user-images.githubusercontent.com/62640332/160285193-c8c6f782-84ea-4864-a672-6e9aa667fa35.png)


---

## application 단 에러 목록

: 오버플로우, Commnad Injection, 임의 파일 실행, 파일 다운로드, 파일 다운로드 및 실행

---



### ㅁ 오버플로우

: 오버플로우 취약점은 연속된 메모리 공간을 사용하는 프로그램에서 할당된 범위를 넘어선 위치에 자룔을 읽거나 쓰려고 할 때 발생

프로그램의 오작동을 유발시키거나 악의적인 코드를 실행시킴으로써 공격자가 프로그램을 통제할 수 있는 권한을 획득

대부분 파일명 또는 파일 포맷 내특정 필드의 길이(size) 값과 실제 데이터 크기에 대한 검증 없이 메모리에 복사하여 취약점 발생

대표적인 예로 아래 Application 프로그램이 HTTP 핸들러를 통해 json 데이터를 받아오는 과정에서 json 데이터 내 type 값이 잘못된 경우, 로그를 기록하는 코드.

이떄 에러 메시지를 저장하는 버퍼(byte_54B218)는 0x200(512byte)로 설정되어 있는데, type 값 (v107)에 대한 기링 검증 없이 오버플로우 취약 함수인 sprintf()를 통해 버퍼에 복사하고 있다.

![image](https://user-images.githubusercontent.com/62640332/160286257-caa2be7a-679f-4399-b51c-1cd2ff514488.png)

따라서, 원래 지정된 버퍼 크기(512Byte) 보다 더 많은 양의 데이터를 버퍼에 쓰는것이 가능해지며, 이를 이용해 프로그램의 실행 흐름을 변조할 수 있다.

취약점 공격을 위해 메모리 특정 위치이에 저장된 함수 포인터를 원하느 코드로 갈 수 있는 메모리 주소로 조작한다.

아래 그림5에서는 0x54bd70 위치에 함수 포인터가 저장되어있으며 이를 0x07505038로 조작해 원하는 코드를 실행할 수 있도록 한다.  

0x07505038 위치에는 힙 스프레이 공격 기법을 사용하여 공격자 쉘 코드가 저장되어 있따.

즉 아래오 같이 취약한 함수에 데이터를 넣는 코드를 삽입한 조작된 웹페이지를 해당 application 사요자가 접속할 경우  악성코드가 실행될 수 있다.

또한, 웹서버랑 통신하는 Non-ActiveX의 경우, 공가자가 해당 사용자 IP만 알아도 공격 패킷(취약함 함수 악용)을 보내 사용자의 상호작용 없이 공격을 수행할 수 있다.

![image](https://user-images.githubusercontent.com/62640332/160286464-6fef2912-5d8d-4d7f-89b7-9dd569a00782.png)

\# 힙스프레이 기법 : 페이로드를 전달하는 방법.  마치 스프레이로 뿌리는 것처럼 힙 메모리영역에 대량의 메모리를 할당하고 코드를 삽입.

따라서 힙 메모리에 대하여 예측 가능한 메모리 영역에 쉘 코드를 삽입하는 것이 가능.

데이터를 삽입시 보통 많이 사용하는 방법은 대량의 NOP 코드와 목적하는 공격을 하는 쉘 코드를 결합해 사용한다.

<br>
<br>


- 조치 방안

1. 프로그램 개발 시 오버플로우 발생 가능한 취약한 함수 사용을 시큐어 코딩 적용

- strcpy, strcat, sprintf memcpy 등의 함수

-> strncpy, strncat, snprintf 라이브러리 함수 사용

2. 메모리 버퍼의 경계 값을 넘어 메모리를 읽거나 저장하지 않도록 경계 설정 또는 검사를 반드시 수행

3. 프로그램 상에서 버퍼 사용할 경우 적절한 버퍼 크기 설정하고, 설정된 범위의 메모리 내에서 올바르게 읽거나 쓸수 있게 통제. 

- 문자열 저장 시 널(Null) 문자를 버퍼 범위 내에 삽입하여 널(Null) 문자로 종료되도록 처리

![image](https://user-images.githubusercontent.com/62640332/160286740-31904643-b43c-4968-879b-6c2a6550cab3.png)

4. 취약 함수 존재하더라도 공격자가 공격에 성공하기 어렵도록 Non-executable Stack, 스택가드(StackGuard), ASLR 등과 같은 메모리 보호 기법 적용


<br>
<br>
<br>

---

### ㅁ 명령어 삽입(Command Injection)

: 명령어 삽입 취약점은 적절한 검증 절차를 거치지 않은 사용자 입력 갑셍 의해 의도하지 않은 시스템 명려어가 실행되어 부적절하게 사용자 권한이 변경되거나 시스템 동작 및 운영에 악영향을 미칠수 있는 취약점.

주로 신고되는 Command Injection 취약점은 프로그램을 실행할 떄 커스텀 프로토콜 핸들러르 사용하는 프로그램에서 클라이언트 프로세스에 전달되는 인자 값을 검증 절차 없이 쉘 실행 함수로 실행하는 유형.

예를 들어 아래 그림과 같이 프로그램을 실행시 커스텀 프로토콜 핸들러(kisa://)를 통해 특정 문자열이 전달된다.

해당 문자열이 Blowfish로 암호화한 값을 16진수 문자열로 인코딩한것.

![image](https://user-images.githubusercontent.com/62640332/160287163-ed7d0e90-19b1-4d99-b845-eaea1e445657.png)

암호화 된 문자열은 프로그램 내부에서 복호화되며, 복호화 된 문자열을 확인해 본 결과 아래 그림과 같이 외부 서버의 프로그램이 전달되고 있는것을 알수 있다.

![image](https://user-images.githubusercontent.com/62640332/160287186-57dedf8e-ef69-487a-8097-1998a1d59ff3.png)

복호화 된 문자열은 strtok() 함수로 분리한 뒤 여러 변수에 저장되고, 해당 변수는 아래 그림과 같이 최종적으로 ShellExecuteA() 함수에 전달되는 문자열에 사용되어 인자 값으로 실행된다.

![image](https://user-images.githubusercontent.com/62640332/160287259-2ab9e2ff-a3cd-4b1f-84de-5afafef419b1.png)

이렇게 커스텀 프로토콜 핸들러 내 악의적인 명령어가 삽입된 웹페이지에 사용자가 접속할 경우, 악성코드에 감염될 수 있으니 실행 전 문자열 검증 필요.

<br>
<br>

- 조치방안

1. 외부 입력 값을 이용하여 시스템 자원(IP, PORT번호, 메모리, 파일 등)을 식별하는 경우 허가되지 않은 자원이 사용되지 않도록 해야함.
    
    - 기능 설계 시 사용해야 하는 리소스 목록을 정의하여 지정된 범위 안에서 리소스를 선택하여 사용하도록함
    - 리소스 목록은 ProPerty 파일이나 XML 파일로 정의하여 리소스 정보를 변경하는 경우 프로그램 수정을 최소화할수 있도록 관리

2. 서버 프로그램 안에서 쉘을 생성하여 명령어를 실행해야 하는 경우 외부 입력 값에 의해 악의적인 명령어가 실행되지 않도록 함
    
    - 쉘 실행 함수(ShellExecuteW(), ShellExecuteExW(), ShellExecute() 등) 사용 자제
    - 쉘 실행 함수가 꼭 필요한 경우 외부 입력 값이 직접적으로 명령어의 일부를 사용되지 않도록 조치
      - 명령어의 일부로 사용되어야 하는 값들을 목록화하여 목록 내에 있는 값들로만 명령어가 조립되어 실행될수 있도록 조치
      - 목록화되어 있는 값들이 경우에 따라 변경되어야 한다면, 이로 인해 프로그램이 수정되지 않도록 Property 파일이나 XML 파일을 사용하여 허용 목록 작성


3. 외부 입력 값에 대한 빠짐없는 경로 탐색 패턴(../ , ..\\, \\.., ./. .\\ 등)필터링 필요
   
   - 아래와 같이 일부만 검증할 경우 탐지되지 않는 패턴으로 우회하여 공격 가능하므로 주의
   
   ```
   // 우회 가능한 필터링 예제
   v3 = this; //경로값
   while (check("\\..\\", &a);
   ...
   while (check("\\..\\", &a);
   while (check("\\\\", &a);
   // 이럴 경우 \\..\\ 또는 \../ 등으로 경로 탐지 패턴 우회하여 상위 파일 접근 가능
   ```
   - 프로그램 내 하드코딩된 키로 입력 값(핸들러 내 명령어)등을 암호화해도 제 3자(공격자)가 악성 명령어를 프로그램 역분석을 통해 알아낸 하드코딩된 키로 동일하게 암호화 할 경우 우회되어 실행 가능.
   - 소스코드 내부에 상수화된(하드코딩된) 암호화키를 사용하면 안 됨

---

## service 단 에러 목록

: XSS, 부적절한 권한 검증, SQL Injection, URL Redirection, 취약한 인증 및 세션 관리

---

### ㅁ 부적절한 권한 검증

: 부적절한 권한 검증 취약점은 웹 사이트에서 요청이 발생할 때, 적절한 인증 과정 없이 중요 정보를 타인이 열람, 수정, 삭제 등을 할 수 있다는 취약점 입니다.

예를 들면, 특정 게시판에 작성된 글을 수정할 떄 아래와 같은 http 요청이 전송된다.

웹 애플리케이션은 게시 글을 구분하기 위한 값을 고유 번호로 할당해 데이터베이스 등의 저장소에 저장하고, 이후 게시 글 수정을 요청하면 저장된 게시 글의 고유번호를 사용자가 요청한 값과 비교하여 처리한다.

![image](https://user-images.githubusercontent.com/62640332/160289639-81c04f9b-cd40-4399-b120-3000b0710316.png)

전송되는 게시 글의 고유번호 값으로만 인증하는 검증 방식을 사용할 경우, 공격자는 웹 프록시 도구를 이용, 게시 글 번호로 변경해 타인이 작성한 글을 수정할 수 있습니다.

![image](https://user-images.githubusercontent.com/62640332/160289699-22a194ce-48f8-4f0a-be3d-7939ea0a7e96.png)


- <조치 방안>

1. 중요 정보를 확인하는 페이지(개인정보 관련 페이지, 비밀글 게시 등)에 대한 사용자 검증 절차 강화
    - 페이지 접근을 요청한 사용자와 로그인한 사용자의 일치 여부 확인
    
    ```
    String userId = (string) session.getAttribute("userId");
    string passwd = request.getParameter("oldUserPw");

    / 실제 요청한 사용자와 로그인한 사용자의 일치 여부 확인 보안 코드
    string requestUser = memberMode.getUserlId();
    if(userId != null && requestUser != null && !userId.equals(requestUser){
        ...
    }
    ```

2. 안전한 사용자별 세션 인증 구현
   - 길이와 복잡도가 적절한 일회성 세션 ID를 사용자별로 발급하고 사용자 요청 시 해당 세션 ID 와 일치하는지 확인
  
3. 클라이언트에서 전송되는 값이 신뢰할 수 있는 데이터인지 확인하는 사용자 검증 절차를 클라이언트단이 아닌 서버단에 포함





<br>
<br>
<br>

---

### ㅁ 서비스 내 오픈소스 파일 업로드 취약점

: 웹 사이트에서는 웹 파일 관리자, 웹데이터 등 오픈소스를 많이 활용하고 있다.

소스코드가 공개 되어있기 떄문에 보안 취약성 또한 쉽게 노출 될 수 있는 위험성을 내재하고 있다.

이에 기업/개인 이용자는 오픈소스 보안성 제고의 주의를 기울일 필요가 있다.

공격자는 특정 웹사이트에서 오픈소스 라이브러리가 포함된 것을 확인하면 기존에 알려진 보안 취약점을 악용하여 공격하는 경우가 많다.

예를 들어 아래와 같이 공격자가 웹페이지 코드로부터 사이트에 사용되는 동영상 오픈소스 라이브러리인 ** 파일 관리 프로그램이 쓰이는 것을 확인한ㄷ.

이후 오픈소스의 경우 업데이트를 안 하는 경우가 많으므로 기존에 알려진 파일 관리 프로그램 취약점을 확인한다.

![image](https://user-images.githubusercontent.com/62640332/160290149-b1a6e523-2ae9-44ca-a397-3cdcc26e0bf4.png)

공격자는 해당 오픈소스 프로그램에서 파일 업로드 시, 업로드파일에 대한 확장자 검사를 하지 않는 기존 취약점을 찾는다.

이를 이용해 파일 업로드 시, 서버에 요청하는 http 요청 값 일부를 아래와 같이 수정하여 웹쉘 .php 파일을 업로드 후 웹셀 실행을 통해 서버를 장악하게 될 수 있다.

![image](https://user-images.githubusercontent.com/62640332/160290191-9b5fd634-4e76-4f86-b082-f41ef51a895a.png)

- 조치 방안

1. 기수 지원 전문 업체가 존재하지 않거나 오픈소스 커뮤니티 참여자가 적은경우, 자체 코드 보안성 검토 필요
2. KrCert, NVD(미국 취약점DB), OSS 커뉴티니 등을 모니터링 하여, 지속적으로 보안 업데이트 권장
3. 확장자 검증 시 허용하는 확장자만 올릴수 있도록 수정하는것 권장
   - 실행 권한이 있는 기존 파일이 공격자가 조작한 파일로 변경하지 않도록, 빠짐없이 경로 탐색 패턴(../ , ..\\, \\.., ./, .\\ 등) 필터링 필요
   - 아래와 같이 일부만 검증할 경우 탐지되지 않는 패턴으로 우회하여 파일 업로드 공격 가능하므로 주의


 ```
   // 우회 가능한 필터링 예제
   v3 = this; //경로값
   while (check("\\..\\", &a);
   ...
   while (check("\\..\\", &a);
   while (check("\\\\", &a);
   // 이럴 경우 \\..\\ 또는 \../ 등으로 경로 탐지 패턴 우회하여 상위 파일 접근 가능
```

   - 공격자의 경우 asp, cgi, php, jsp 확장자 외에도 잘 알려지지 않은 .cer, .asa, cdx, hta, phar, aspx 등의 확장자를 이용하여 공격 수행
   - 이외에 확장자 대소문자 치환(.Jsp), NullByte(.jsp%00.jpg), 이중확장자 증을 이용한 우회를 통한 공격을 수행할 수 있으므로 화이트리스트 권장

4. 오픈소스의 경우 취약한 기능 비활성화 등으로 패치 비권장

- 공격자가 파라미터 변경을 통해 비활성화된 기능을 활성화로 변경 할 수 있음(우회) 기존과 동일하게 취약점을 악용하여 공격 가능



<br>
<br>
<br>

---

## 모바일 및 IoT 단 에러 목록

: 오버플로우, 명령어 삽입, 부적절한 권한 검증, 취약한 인증 및 세션 관리, SQL Injection 

모바일 및 IoT 제품들 중 가장 높은 비율을 차지하는 제품군은 공유기와 IP 카메라로, 펌웨어 내 cgi 파일 또는 바이너리 파일에서 발생하는 취약점들이 신고 되고 있음.

공유기와 IP카메라를 포함한 대부분의 IoT 기기들은 플래시 메모리를 사용하는것이 일반적이며, 리눅스 커널을 기반으로 한다.

또한 IoT 제품 취약점은 사용자와의 인터페이스 관리하는 바이너리에서  발생하는 경우가 많다.

IoT 제품의 사용자 인터페이스는 대부분 IoT 기기 관리를 위한 관리자 페이지가 존재하며, 관리자 페이지를 구성하는 웹 서버 데몬을 분석해 사용자 입력 값을 처리되는 과정에서 다양한 취약점들이 발견

---

### ㅁ IoT 오버플로우
















---

## CMS 단 에러 목록

---

---

## ActiveX 단 에러 목록

---